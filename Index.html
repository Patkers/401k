<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 50%, #60a5fa 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: 'üìäüìàüí∞üöÄüíºüìâüí∏üéØ';
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            font-size: 2em;
            opacity: 0.2;
            letter-spacing: 40px;
            animation: float 20s linear infinite;
        }
        
        @keyframes float {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-weight: 800;
            position: relative;
            z-index: 1;
        }
        
        .header h1::before {
            content: 'üöÄ ';
        }
        
        .header h1::after {
            content: ' üí∞';
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .update-date {
            background: rgba(255, 255, 255, 0.25);
            display: inline-block;
            padding: 10px 25px;
            border-radius: 30px;
            margin-top: 15px;
            font-size: 0.95em;
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .dashboard {
            padding: 40px;
        }
        
        .stats-sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0;
        }
        
        .stats-sub-tab {
            padding: 12px 24px;
            background: transparent;
            color: #6b7280;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            bottom: -2px;
        }
        
        .stats-sub-tab:hover {
            color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }
        
        .stats-sub-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: rgba(37, 99, 235, 0.08);
        }
        
        .stats-tab-content {
            display: none;
        }
        
        .stats-tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .stat-card-worst {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card-worst:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .stat-card-worst h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card-worst .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card-worst .label {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.2;
        }
        
        .section-title::before {
            content: '';
            width: 5px;
            height: 30px;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            border-radius: 5px;
            flex-shrink: 0;
        }
        
        .toggle-btn {
            margin-left: auto;
            padding: 8px 20px;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .toggle-btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .toggle-btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        .section-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        
        .section-content.hidden {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        
        .hot-cold-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .hot-cold-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .hot-cold-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .fund-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #ccc;
        }
        
        .fund-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .fund-card.hot {
            border-left-color: #dc2626;
            background: linear-gradient(135deg, #fff 0%, #ffe5e5 100%);
        }
        
        .fund-card.cold {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #fff 0%, #e3f2ff 100%);
        }
        
        .fund-card h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2c3e50;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .fund-card h4:hover {
            color: #3498db;
            text-decoration: underline;
        }
        
        .fund-link {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 600;
        }
        
        .fund-link:hover {
            color: #3498db;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .fund-card .category {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .performance-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .performance-row .metric {
            color: #64748b;
        }
        
        .performance-row .value {
            font-weight: bold;
        }
        
        .performance-row .value.positive {
            color: inherit; /* Use default text color */
        }
        
        .performance-row .value.negative {
            color: #dc2626;
        }
        
        /* Standalone positive/negative classes for grouped layout */
        .positive {
            color: inherit; /* Use default text color */
        }
        
        .negative {
            color: #dc2626;
        }
        
        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }
        
        .chart-title {
            font-size: 1em;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        thead {
            background: #34495e;
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
            position: relative;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .expense-low {
            color: #059669;
            font-weight: bold;
        }
        
        .expense-medium {
            color: #ea580c;
            font-weight: bold;
        }
        
        .expense-high {
            color: #dc2626;
            font-weight: bold;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-btn:hover {
            background: #2c3e50;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        .badge.hot {
            background: #dc2626;
            color: white;
        }
        
        .badge.cold {
            background: #3498db;
            color: white;
        }
        
        .badge.best {
            background: #059669;
            color: white;
        }
        
        .badge.low-fee {
            background: #059669;
            color: white;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: #ecf0f1;
            color: #64748b;
            font-size: 0.9em;
        }
        
        .nav-sidebar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .nav-sidebar-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            min-width: 100px;
            text-align: center;
        }
        
        .nav-sidebar-btn:hover {
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        }
        
        .nav-sidebar-btn:active {
            transform: translateX(-3px);
        }
        
        @media (max-width: 768px) {
            .nav-sidebar {
                right: 10px;
            }
            
            .nav-sidebar-btn {
                padding: 10px 14px;
                font-size: 0.75em;
                min-width: 80px;
            }
        }
        
        .disclaimer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .disclaimer h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .disclaimer p {
            color: #856404;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .hot-cold-grid {
                grid-template-columns: 1fr;
            }
        }
/* Month Management Tabs */
        .month-tabs {
            display: flex;
            gap: 10px;
            padding: 20px 40px 0 40px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .month-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .month-tab:hover {
            background: #e9ecef;
        }
        
        .month-tab.active {
            background: white;
            color: #2563eb;
            border-color: #2563eb;
            border-bottom-color: white;
            position: relative;
            bottom: -2px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .month-controls {
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .month-button {
            padding: 10px 20px;
            background: white;
            border: 2px solid #2563eb;
            border-radius: 8px;
            color: #2563eb;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .month-button:hover {
            background: #2563eb;
            color: white;
        }
        
        .delete-portfolio-btn:hover {
            color: #c0392b !important;
            transform: scale(1.2);
        }
        
        .month-button.active {
            background: #2563eb;
            color: white;
        }
        
        .upload-zone {
            border: 3px dashed #2563eb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone:hover {
            border-color: #1e40af;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .upload-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-subtitle {
            color: #64748b;
            font-size: 1em;
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Investment Portfolio Analyzer</h1>
            <p>Investment Analysis & Comparison Tool</p>
            <div class="update-date" id="dataBadge">üìÖ Dashboard Data: Default View</div>
        </div>
        
        <!-- Portfolio Management Tabs -->
        <div class="month-tabs">
            <div class="month-tab active" onclick="switchMainTab('converter')">üîÑ Excel Converter</div>
            <div class="month-tab" onclick="switchMainTab('importer')">üì§ Import Data</div>
            <div class="month-tab" onclick="switchMainTab('dataentry')">üìù Data Entry</div>
            <div class="month-tab" onclick="switchMainTab('history')">üìÅ My Portfolios</div>
            <div class="month-tab" onclick="switchMainTab('dashboard')">üìä Full Dashboard</div>
        </div>
        
        <!-- Excel Converter Tab -->
        <div id="converter-pane" class="tab-pane active" style="padding: 40px;">
            <h2 style="margin-bottom: 20px;">üîÑ Excel Converter</h2>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>üìã Steps:</strong><br>
                1. Get PDF from Network Health<br>
                2. Convert at <strong>ilovepdf.com</strong> ‚Üí PDF to Excel<br>
                3. Delete top 2 rows in Excel, save<br>
                4. Upload here ‚Üí Download converted file<br>
                5. Go to "Import Data" tab to load it!
            </div>
            <div class="upload-zone" onclick="document.getElementById('converterFileInput').click()">
                <div class="upload-icon">üì§</div>
                <div class="upload-title">Click to Upload Excel File</div>
                <div class="upload-subtitle">The cleaned file from ilovepdf (top 2 rows deleted)</div>
                <input type="file" id="converterFileInput" accept=".xlsx,.xls" onchange="handleConverterUpload(event)" style="display: none;">
            </div>
            <div id="converterResult" style="display: none; margin-top: 20px; text-align: center;">
                <div id="converterStatus" style="padding: 20px; background: #d4edda; border-radius: 10px; margin-bottom: 20px;"></div>
                <button onclick="downloadConvertedFile()" style="padding: 15px 30px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: 600;">
                    üì• Download Dashboard-Ready File
                </button>
            </div>
        </div>
        
        <!-- Import Data Tab -->
        <div id="importer-pane" class="tab-pane" style="padding: 40px;">
            <h2 style="margin-bottom: 20px;">üì§ Import Data for: <span id="currentMonthName" style="color: #2563eb;">Select a portfolio first</span></h2>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è Important:</strong> Create a portfolio in "My Portfolios" tab first, then come back here to import data!
            </div>
            <div class="upload-zone" onclick="document.getElementById('importFileInput').click()">
                <div class="upload-icon">üì§</div>
                <div class="upload-title">Click to Upload Converted Excel File</div>
                <div class="upload-subtitle">The file you downloaded from Excel Converter</div>
                <input type="file" id="importFileInput" accept=".xlsx,.xls" onchange="handleDataImport(event)" style="display: none;">
            </div>
            
            <!-- Download Current Portfolio Button -->
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="downloadCurrentPortfolio()" style="padding: 12px 30px; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üíæ Download Current Portfolio Data
                </button>
                <p style="font-size: 0.85em; color: #64748b; margin-top: 10px;">Download the CSV data currently loaded in: <span id="downloadPortfolioName" style="font-weight: 600; color: #2563eb;">No portfolio selected</span></p>
            </div>
            
            <!-- Audit Preview Table -->
            <div id="auditPreview" style="display: none; margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üìã Import Preview - Verify Your Data:</h3>
                <div style="max-height: 400px; overflow-y: auto; border: 2px solid #2563eb; border-radius: 10px; background: white;">
                    <table id="auditTable" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead style="position: sticky; top: 0; background: #2563eb; color: white; z-index: 10;">
                            <tr>
                                <th style="padding: 12px; text-align: left;">#</th>
                                <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortAuditTable('name')">
                                    Fund Name <span id="sort-name">‚áÖ</span>
                                </th>
                                <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortAuditTable('ticker')">
                                    Ticker <span id="sort-ticker">‚áÖ</span>
                                </th>
                                <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortAuditTable('ytd')">
                                    YTD % <span id="sort-ytd">‚áÖ</span>
                                </th>
                                <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortAuditTable('1_month')">
                                    1 Mo % <span id="sort-1_month">‚áÖ</span>
                                </th>
                                <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortAuditTable('1_year')">
                                    1 Yr % <span id="sort-1_year">‚áÖ</span>
                                </th>
                                <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortAuditTable('category')">
                                    Category <span id="sort-category">‚áÖ</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="confirmImport()" style="padding: 15px 40px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-right: 10px;">
                        ‚úÖ Looks Good - Confirm Import
                    </button>
                    <button onclick="cancelImport()" style="padding: 15px 40px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer;">
                        ‚ùå Cancel Import
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Data Entry Tab -->
        <div id="dataentry-pane" class="tab-pane" style="padding: 40px;">
            <style>
                #dataentry-pane .data-entry-container {
                    max-width: 1600px;
                    margin: 0 auto;
                }
                
                #dataentry-pane h2 {
                    color: #2c3e50;
                    margin-bottom: 10px;
                    font-size: 2em;
                    text-align: center;
                }
                
                #dataentry-pane .subtitle {
                    text-align: center;
                    color: #64748b;
                    margin-bottom: 30px;
                    font-size: 1.1em;
                }
                
                #dataentry-pane .instructions {
                    background: #e8f4fd;
                    border-left: 4px solid #2980b9;
                    padding: 20px;
                    margin-bottom: 30px;
                    border-radius: 8px;
                }
                
                #dataentry-pane .instructions h3 {
                    color: #2980b9;
                    margin-bottom: 10px;
                }
                
                #dataentry-pane .instructions ol {
                    margin-left: 20px;
                    color: #34495e;
                    line-height: 1.8;
                }
                
                #dataentry-pane .action-buttons {
                    display: flex;
                    gap: 15px;
                    justify-content: center;
                    margin-bottom: 30px;
                    flex-wrap: wrap;
                }
                
                #dataentry-pane .btn {
                    padding: 15px 30px;
                    border-radius: 10px;
                    font-weight: 700;
                    font-size: 1.1em;
                    text-align: center;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-decoration: none;
                    display: inline-block;
                }
                
                #dataentry-pane .btn-primary {
                    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                    color: white;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                }
                
                #dataentry-pane .btn-primary:hover {
                    transform: scale(1.05);
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
                }
                
                #dataentry-pane .btn-success {
                    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                    color: white;
                    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
                }
                
                #dataentry-pane .btn-success:hover {
                    transform: scale(1.05);
                    box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
                }
                
                #dataentry-pane .btn-warning {
                    background: linear-gradient(135deg, #60a5fa 0%, #f5576c 100%);
                    color: white;
                    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
                }
                
                #dataentry-pane .btn-warning:hover {
                    transform: scale(1.05);
                    box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
                }
                
                #dataentry-pane .progress-bar {
                    background: #e9ecef;
                    border-radius: 25px;
                    padding: 15px 30px;
                    margin: 20px 0;
                    text-align: center;
                    font-weight: 700;
                    font-size: 1.1em;
                    color: #2c3e50;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                }
                
                #dataentry-pane .fund-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                
                #dataentry-pane .fund-table thead {
                    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                    color: white;
                }
                
                #dataentry-pane .fund-table th {
                    padding: 15px;
                    text-align: left;
                    font-weight: 700;
                    font-size: 0.95em;
                }
                
                #dataentry-pane .fund-table td {
                    padding: 12px 15px;
                    border-bottom: 1px solid #ecf0f1;
                }
                
                #dataentry-pane .fund-table tbody tr:hover {
                    background: #f8f9fa;
                }
                
                #dataentry-pane .fund-name {
                    font-weight: 600;
                    color: #2c3e50;
                    font-size: 0.95em;
                    margin-bottom: 3px;
                }
                
                #dataentry-pane .ticker {
                    color: #2563eb;
                    font-weight: 700;
                    font-size: 0.9em;
                    background: #e8f0ff;
                    padding: 2px 8px;
                    border-radius: 4px;
                }
                
                #dataentry-pane .category {
                    color: #64748b;
                    font-size: 0.85em;
                    margin-top: 3px;
                }
                
                #dataentry-pane .yahoo-link {
                    display: inline-block;
                    padding: 8px 16px;
                    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    font-weight: 600;
                    font-size: 0.9em;
                    transition: all 0.2s;
                }
                
                #dataentry-pane .yahoo-link:hover {
                    transform: scale(1.05);
                }
                
                #dataentry-pane .input-field {
                    width: 80px;
                    padding: 8px;
                    border: 2px solid #dce4ec;
                    border-radius: 6px;
                    text-align: center;
                    font-size: 0.9em;
                    transition: border 0.2s;
                }
                
                #dataentry-pane .input-field:focus {
                    outline: none;
                    border-color: #2563eb;
                    background: #dbeafe;
                }
                
                #dataentry-pane .input-field.filled {
                    background: #d4edda;
                    border-color: #059669;
                }
                
                #dataentry-pane .footer {
                    text-align: center;
                    margin-top: 40px;
                    padding-top: 30px;
                    border-top: 2px solid #ecf0f1;
                    color: #64748b;
                }
                
                #dataentry-pane .upload-area {
                    border: 3px dashed #2563eb;
                    border-radius: 10px;
                    padding: 30px;
                    text-align: center;
                    margin: 20px 0;
                    background: #f8f9fa;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                #dataentry-pane .upload-area:hover {
                    background: #e9ecef;
                    border-color: #1e40af;
                }
                
                #dataentry-pane .upload-area.dragover {
                    background: #e8f4fd;
                    border-color: #2980b9;
                }
                
                #dataentry-pane #fileInputDE {
                    display: none;
                }
                
                #dataentry-pane .alert {
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                    display: none;
                }
                
                #dataentry-pane .alert-success {
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    color: #155724;
                }
                
                #dataentry-pane .alert-error {
                    background: #f8d7da;
                    border: 1px solid #f5c6cb;
                    color: #721c24;
                }
            </style>
            
            <div class="data-entry-container">
                <h2>üìä Portfolio Data Entry Tool</h2>
                <p class="subtitle">Fill in returns, export to CSV, import to dashboard!</p>
                
                <div class="instructions">
                    <h3>üéØ How to Use:</h3>
                    <ol>
                        <li><strong>Upload your CSV file</strong> (with fund names, tickers, categories, etc.) OR click "‚ûï Add New Fund" to manually add funds</li>
                        <li><strong>Check/uncheck boxes</strong> next to funds you want to open in Yahoo Finance</li>
                        <li>Click "Open Selected in Yahoo" to open only checked funds in separate tabs</li>
                        <li>OR click individual "üìà Yahoo" buttons for one-at-a-time access</li>
                        <li>Copy the returns (YTD, 1mo, 3mo, 1yr, 3yr, 5yr, 10yr) and paste into the input fields</li>
                        <li>Click "Download CSV" when done - includes any manually added funds!</li>
                        <li>Import the CSV to your dashboard using the "Import Data" tab!</li>
                    </ol>
                </div>
                
                <div id="alertBoxDE" class="alert"></div>
                
                <div class="upload-area" onclick="document.getElementById('fileInputDE').click()" id="uploadAreaDE">
                    <h3>üìÅ Upload Existing CSV (Optional)</h3>
                    <p>Click here or drag & drop a CSV file to pre-fill existing data</p>
                    <input type="file" id="fileInputDE" accept=".csv" onchange="handleFileUploadDE(event)">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="openAllTabsDE()">üöÄ Open Selected in Yahoo (New Tabs)</button>
                    <button class="btn btn-success" onclick="downloadCSVDE()">üíæ Download CSV</button>
                    <button class="btn btn-primary" onclick="clearAllDE()">üîÑ Clear All Data</button>
                    <button class="btn btn-primary" onclick="toggleAddFundFormDE()" style="background: linear-gradient(135deg, #60a5fa 0%, #f5576c 100%);">‚ûï Add New Fund</button>
                </div>
                
                <!-- Add Fund Form -->
                <div id="addFundFormDE" style="display: none; background: #f8f9fa; padding: 30px; border-radius: 12px; border: 3px solid #2563eb; margin: 20px 0;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">‚ûï Add New Fund Manually</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Fund Name *</label>
                            <input type="text" id="newFundNameDE" placeholder="Vanguard 500 Index" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Ticker Symbol *</label>
                            <input type="text" id="newFundTickerDE" placeholder="VFIAX" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; text-transform: uppercase;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Category *</label>
                            <select id="newFundCategoryDE" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                                <option value="">-- Select Category --</option>
                                <option value="Large-Cap Stocks">Large-Cap Stocks</option>
                                <option value="Mid-Cap Stocks">Mid-Cap Stocks</option>
                                <option value="Small-Cap Stocks">Small-Cap Stocks</option>
                                <option value="International Stocks">International Stocks</option>
                                <option value="Emerging Markets">Emerging Markets</option>
                                <option value="Bonds">Bonds</option>
                                <option value="Bond Index">Bond Index</option>
                                <option value="Money Market">Money Market</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Target Date">Target Date</option>
                                <option value="Balanced">Balanced</option>
                                <option value="Multi-Asset/Other">Multi-Asset/Other</option>
                                <option value="Sector Funds">Sector Funds</option>
                                <option value="Commodities">Commodities</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Inception Date</label>
                            <input type="text" id="newFundInceptionDE" placeholder="01/01/2000" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="saveNewFundDE()" style="padding: 12px 30px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚úÖ Add Fund</button>
                        <button onclick="toggleAddFundFormDE()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚ùå Cancel</button>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <span id="progressDE">Filled: 0 / 0 fields (0%)</span>
                </div>
                
                <table class="fund-table">
                    <thead>
                        <tr>
                            <th style="width: 3%">
                                <input type="checkbox" id="selectAllDE" onchange="toggleSelectAllDE()" title="Select/Deselect All">
                            </th>
                            <th style="width: 20%; cursor: pointer;" onclick="sortTableDE('name')" title="Click to sort">
                                Fund / Ticker / Category <span id="sort-name-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%">Yahoo Link</th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('ytd')" title="Click to sort">
                                YTD % <span id="sort-ytd-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('mo1')" title="Click to sort">
                                1 Mo % <span id="sort-mo1-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('mo3')" title="Click to sort">
                                3 Mo % <span id="sort-mo3-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('yr1')" title="Click to sort">
                                1 Yr % <span id="sort-yr1-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('yr3')" title="Click to sort">
                                3 Yr % <span id="sort-yr3-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('yr5')" title="Click to sort">
                                5 Yr % <span id="sort-yr5-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('yr10')" title="Click to sort">
                                10 Yr % <span id="sort-yr10-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('inception')" title="Click to sort">
                                Incept % <span id="sort-inception-de">‚áÖ</span>
                            </th>
                            <th style="width: 7%; cursor: pointer;" onclick="sortTableDE('expense')" title="Click to sort">
                                Expense % <span id="sort-expense-de">‚áÖ</span>
                            </th>
                            <th style="width: 3%">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="fundTableBodyDE">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
                
                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="downloadCSVDE()">üíæ Download CSV</button>
                </div>
                
                <div class="footer">
                    <p><strong>üí° Pro Tip:</strong> Use this tool every month for easy data entry!</p>
                    <p style="margin-top: 10px;">All data is stored locally in your browser. Nothing is sent to any server.</p>
                </div>
            </div>
            
            <script>
                // Fund data for Data Entry tab - separate from main dashboard
                let fundsDE = [];
                
                // Initialize table
                function initializeTableDE(preserveValues = false) {
                    const tbody = document.getElementById('fundTableBodyDE');
                    
                    // Save current values if preserving
                    let savedValues = {};
                    if (preserveValues) {
                        fundsDE.forEach((fund, index) => {
                            const ytd = document.getElementById(`ytd_de_${index}`);
                            const mo1 = document.getElementById(`mo1_de_${index}`);
                            const mo3 = document.getElementById(`mo3_de_${index}`);
                            const yr1 = document.getElementById(`yr1_de_${index}`);
                            const yr3 = document.getElementById(`yr3_de_${index}`);
                            const yr5 = document.getElementById(`yr5_de_${index}`);
                            const yr10 = document.getElementById(`yr10_de_${index}`);
                            const inception = document.getElementById(`inception_de_${index}`);
                            const expense = document.getElementById(`expense_de_${index}`);
                            
                            savedValues[index] = {
                                ytd: ytd ? ytd.value : '',
                                mo1: mo1 ? mo1.value : '',
                                mo3: mo3 ? mo3.value : '',
                                yr1: yr1 ? yr1.value : '',
                                yr3: yr3 ? yr3.value : '',
                                yr5: yr5 ? yr5.value : '',
                                yr10: yr10 ? yr10.value : '',
                                inception: inception ? inception.value : '',
                                expense: expense ? expense.value : ''
                            };
                        });
                    }
                    
                    tbody.innerHTML = '';
                    
                    if (fundsDE.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 40px; color: #64748b; font-size: 1.1em;">üìÅ Upload a CSV file or click "‚ûï Add New Fund" to get started</td></tr>';
                        return;
                    }
                    
                    fundsDE.forEach((fund, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="text-align: center;">
                                <input type="checkbox" class="fund-checkbox-de" id="check_de_${index}" checked>
                            </td>
                            <td>
                                <div class="fund-name">${fund.name}</div>
                                <div><span class="ticker">${fund.ticker}</span></div>
                                <div class="category">${fund.category}</div>
                            </td>
                            <td>
                                <a href="https://finance.yahoo.com/quote/${fund.ticker}/performance" target="YahooFinanceWindow" class="yahoo-link">
                                    üìà Yahoo
                                </a>
                            </td>
                            <td><input type="text" class="input-field" id="ytd_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].ytd : (fund.ytd || '')}"></td>
                            <td><input type="text" class="input-field" id="mo1_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].mo1 : (fund.mo1 || '')}"></td>
                            <td><input type="text" class="input-field" id="mo3_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].mo3 : (fund.mo3 || '')}"></td>
                            <td><input type="text" class="input-field" id="yr1_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].yr1 : (fund.yr1 || '')}"></td>
                            <td><input type="text" class="input-field" id="yr3_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].yr3 : (fund.yr3 || '')}"></td>
                            <td><input type="text" class="input-field" id="yr5_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].yr5 : (fund.yr5 || '')}"></td>
                            <td><input type="text" class="input-field" id="yr10_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].yr10 : (fund.yr10 || '')}"></td>
                            <td><input type="text" class="input-field" id="inception_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].inception : (fund.inception_value || '')}"></td>
                            <td><input type="text" class="input-field" id="expense_de_${index}" oninput="updateProgressDE()" placeholder="0.00" value="${savedValues[index] ? savedValues[index].expense : (fund.expense || '0.00')}"></td>
                            <td style="text-align: center;">
                                <button onclick="deleteFundDE(${index})" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 600;" title="Delete this fund">üóëÔ∏è</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    updateProgressDE();
                }
                
                // Sorting state
                let sortColumnDE = null;
                let sortDirectionDE = 'asc';
                
                // Sort table by column
                function sortTableDE(column) {
                    // Toggle direction if clicking same column
                    if (sortColumnDE === column) {
                        sortDirectionDE = sortDirectionDE === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumnDE = column;
                        sortDirectionDE = 'asc';
                    }
                    
                    // Update sort indicators
                    document.querySelectorAll('[id^="sort-"][id$="-de"]').forEach(el => {
                        el.textContent = '‚áÖ';
                    });
                    const indicator = document.getElementById(`sort-${column}-de`);
                    if (indicator) {
                        indicator.textContent = sortDirectionDE === 'asc' ? '‚Üë' : '‚Üì';
                    }
                    
                    // Get current values from inputs
                    fundsDE.forEach((fund, index) => {
                        const ytdEl = document.getElementById(`ytd_de_${index}`);
                        const mo1El = document.getElementById(`mo1_de_${index}`);
                        const mo3El = document.getElementById(`mo3_de_${index}`);
                        const yr1El = document.getElementById(`yr1_de_${index}`);
                        const yr3El = document.getElementById(`yr3_de_${index}`);
                        const yr5El = document.getElementById(`yr5_de_${index}`);
                        const yr10El = document.getElementById(`yr10_de_${index}`);
                        const inceptionEl = document.getElementById(`inception_de_${index}`);
                        const expenseEl = document.getElementById(`expense_de_${index}`);
                        
                        if (ytdEl) fund.ytd = ytdEl.value;
                        if (mo1El) fund.mo1 = mo1El.value;
                        if (mo3El) fund.mo3 = mo3El.value;
                        if (yr1El) fund.yr1 = yr1El.value;
                        if (yr3El) fund.yr3 = yr3El.value;
                        if (yr5El) fund.yr5 = yr5El.value;
                        if (yr10El) fund.yr10 = yr10El.value;
                        if (inceptionEl) fund.inception_value = inceptionEl.value;
                        if (expenseEl) fund.expense = expenseEl.value;
                    });
                    
                    // Sort the funds array
                    fundsDE.sort((a, b) => {
                        let aVal, bVal;
                        
                        if (column === 'name') {
                            aVal = a.name.toLowerCase();
                            bVal = b.name.toLowerCase();
                            return sortDirectionDE === 'asc' 
                                ? aVal.localeCompare(bVal) 
                                : bVal.localeCompare(aVal);
                        } else {
                            // Numeric columns
                            // Special case: inception column stores data in inception_value
                            const fieldName = column === 'inception' ? 'inception_value' : column;
                            aVal = parseFloat(a[fieldName]) || -Infinity;
                            bVal = parseFloat(b[fieldName]) || -Infinity;
                            return sortDirectionDE === 'asc' 
                                ? aVal - bVal 
                                : bVal - aVal;
                        }
                    });
                    
                    // Rebuild table with sorted data (don't preserve values as we just saved them)
                    initializeTableDE(false);
                }
                
                // Update progress
                function updateProgressDE() {
                    if (fundsDE.length === 0) {
                        document.getElementById('progressDE').textContent = 'Filled: 0 / 0 fields (0%)';
                        return;
                    }
                    
                    const totalFields = fundsDE.length * 7; // 7 return fields per fund (not expense)
                    let filledFields = 0;
                    
                    fundsDE.forEach((fund, index) => {
                        const fields = ['ytd', 'mo1', 'mo3', 'yr1', 'yr3', 'yr5', 'yr10'];
                        fields.forEach(field => {
                            const input = document.getElementById(`${field}_de_${index}`);
                            if (input && input.value.trim() !== '') {
                                filledFields++;
                                input.classList.add('filled');
                            } else if (input) {
                                input.classList.remove('filled');
                            }
                        });
                    });
                    
                    const percentage = Math.round((filledFields / totalFields) * 100);
                    document.getElementById('progressDE').textContent = `Filled: ${filledFields} / ${totalFields} fields (${percentage}%)`;
                }
                
                // Open all selected tabs in Yahoo Finance
                function openAllTabsDE() {
                    const selectedFunds = [];
                    fundsDE.forEach((fund, index) => {
                        const checkbox = document.getElementById(`check_de_${index}`);
                        if (checkbox && checkbox.checked) {
                            selectedFunds.push(fund);
                        }
                    });
                    
                    if (selectedFunds.length === 0) {
                        showAlertDE('Please check at least one fund!', 'error');
                        return;
                    }
                    
                    if (selectedFunds.length > 20) {
                        if (!confirm(`You're about to open ${selectedFunds.length} tabs. This might be blocked by your browser. Continue?`)) {
                            return;
                        }
                    }
                    
                    // Open each fund in a new tab with slight delays to avoid popup blocker
                    selectedFunds.forEach((fund, index) => {
                        setTimeout(() => {
                            window.open(`https://finance.yahoo.com/quote/${fund.ticker}/performance`, '_blank');
                        }, index * 100); // 100ms delay between each tab
                    });
                    
                    showAlertDE(`Opening ${selectedFunds.length} Yahoo Finance tabs...`, 'success');
                }
                
                // Toggle select all checkboxes
                function toggleSelectAllDE() {
                    const selectAll = document.getElementById('selectAllDE');
                    const checkboxes = document.querySelectorAll('.fund-checkbox-de');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }
                
                // Download CSV
                function downloadCSVDE() {
                    if (fundsDE.length === 0) {
                        showAlertDE('Please upload a CSV file first!', 'error');
                        return;
                    }
                    
                    let csvContent = "Fund Name,Ticker Symbol,Category,Inception Date,Unit Value,YTD Return (%),1 Month Return (%),3 Month Return (%),1 Year Return (%),3 Year Return (%),5 Year Return (%),10 Year Return (%),Inception Return (%),Net Expense Ratio (%)\n";
                    
                    fundsDE.forEach((fund, index) => {
                        const ytd = document.getElementById(`ytd_de_${index}`).value || '';
                        const mo1 = document.getElementById(`mo1_de_${index}`).value || '';
                        const mo3 = document.getElementById(`mo3_de_${index}`).value || '';
                        const yr1 = document.getElementById(`yr1_de_${index}`).value || '';
                        const yr3 = document.getElementById(`yr3_de_${index}`).value || '';
                        const yr5 = document.getElementById(`yr5_de_${index}`).value || '';
                        const yr10 = document.getElementById(`yr10_de_${index}`).value || '';
                        const inception = document.getElementById(`inception_de_${index}`).value || '';
                        const expense = document.getElementById(`expense_de_${index}`).value || fund.expense;
                        
                        csvContent += `"${fund.name}",${fund.ticker},${fund.category},${fund.inception},${fund.unit_value || ''},${ytd},${mo1},${mo3},${yr1},${yr3},${yr5},${yr10},${inception},${expense}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const date = new Date().toISOString().split('T')[0];
                    a.download = `Portfolio_Data_${date}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showAlertDE('CSV downloaded successfully! Import it using the "Import Data" tab.', 'success');
                }
                
                // Clear all data
                function clearAllDE() {
                    if (confirm('Clear all data and reset to empty? You will need to upload a CSV again.')) {
                        fundsDE = [];
                        initializeTableDE();
                        updateProgressDE();
                        showAlertDE('All data cleared! Upload a CSV to start fresh.', 'success');
                    }
                }
                
                // Handle file upload
                function handleFileUploadDE(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const text = e.target.result;
                            const lines = text.split('\n');
                            
                            // Clear existing funds
                            fundsDE = [];
                            
                            // Skip header, process data lines
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                // Parse CSV line - split by comma but handle quoted values
                                const values = [];
                                let current = '';
                                let inQuotes = false;
                                
                                for (let j = 0; j < line.length; j++) {
                                    const char = line[j];
                                    
                                    if (char === '"') {
                                        inQuotes = !inQuotes;
                                    } else if (char === ',' && !inQuotes) {
                                        values.push(current.trim());
                                        current = '';
                                    } else {
                                        current += char;
                                    }
                                }
                                // Push last value
                                values.push(current.trim());
                                
                                if (!values || values.length < 4) continue;
                                
                                const fundName = values[0].replace(/"/g, '').trim();
                                const ticker = values[1].replace(/"/g, '').trim();
                                const category = values[2].replace(/"/g, '').trim();
                                const inception_date = values[3].replace(/"/g, '').trim();
                                const unit_value = values[4] ? values[4].replace(/"/g, '').trim() : '';
                                const ytd = values[5] ? values[5].replace(/"/g, '').trim() : '';
                                const mo1 = values[6] ? values[6].replace(/"/g, '').trim() : '';
                                const mo3 = values[7] ? values[7].replace(/"/g, '').trim() : '';
                                const yr1 = values[8] ? values[8].replace(/"/g, '').trim() : '';
                                const yr3 = values[9] ? values[9].replace(/"/g, '').trim() : '';
                                const yr5 = values[10] ? values[10].replace(/"/g, '').trim() : '';
                                const yr10 = values[11] ? values[11].replace(/"/g, '').trim() : '';
                                const inception_return = values[12] ? values[12].replace(/"/g, '').trim() : '';
                                const expense = values[13] ? values[13].replace(/"/g, '').trim() : '0.00';
                                
                                fundsDE.push({
                                    name: fundName,
                                    ticker: ticker,
                                    category: category,
                                    inception: inception_date,  // This is the DATE (for display and CSV export)
                                    unit_value: unit_value,  // Unit Value
                                    inception_value: inception_return,  // This is the RETURN % (for input field)
                                    expense: expense,
                                    ytd: ytd,
                                    mo1: mo1,
                                    mo3: mo3,
                                    yr1: yr1,
                                    yr3: yr3,
                                    yr5: yr5,
                                    yr10: yr10
                                });
                            }
                            
                            // Rebuild table with loaded data
                            initializeTableDE();
                            
                            // Pre-fill the values
                            fundsDE.forEach((fund, index) => {
                                if (fund.ytd) document.getElementById(`ytd_de_${index}`).value = fund.ytd;
                                if (fund.mo1) document.getElementById(`mo1_de_${index}`).value = fund.mo1;
                                if (fund.mo3) document.getElementById(`mo3_de_${index}`).value = fund.mo3;
                                if (fund.yr1) document.getElementById(`yr1_de_${index}`).value = fund.yr1;
                                if (fund.yr3) document.getElementById(`yr3_de_${index}`).value = fund.yr3;
                                if (fund.yr5) document.getElementById(`yr5_de_${index}`).value = fund.yr5;
                                if (fund.yr10) document.getElementById(`yr10_de_${index}`).value = fund.yr10;
                                if (fund.inception_value) document.getElementById(`inception_de_${index}`).value = fund.inception_value;
                                if (fund.expense) document.getElementById(`expense_de_${index}`).value = fund.expense;
                            });
                            
                            updateProgressDE();
                            showAlertDE(`CSV loaded successfully! ${fundsDE.length} funds imported.`, 'success');
                        } catch (error) {
                            showAlertDE('Error reading CSV file. Please check the format.', 'error');
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                }
                
                // Drag and drop
                const uploadAreaDE = document.getElementById('uploadAreaDE');
                if (uploadAreaDE) {
                    uploadAreaDE.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadAreaDE.classList.add('dragover');
                    });
                    
                    uploadAreaDE.addEventListener('dragleave', () => {
                        uploadAreaDE.classList.remove('dragover');
                    });
                    
                    uploadAreaDE.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadAreaDE.classList.remove('dragover');
                        const file = e.dataTransfer.files[0];
                        if (file) {
                            document.getElementById('fileInputDE').files = e.dataTransfer.files;
                            handleFileUploadDE({ target: { files: [file] } });
                        }
                    });
                }
                
                // Show alert
                function showAlertDE(message, type) {
                    const alertBox = document.getElementById('alertBoxDE');
                    alertBox.textContent = message;
                    alertBox.className = `alert alert-${type}`;
                    alertBox.style.display = 'block';
                    setTimeout(() => {
                        alertBox.style.display = 'none';
                    }, 5000);
                }
                
                // Toggle add fund form
                function toggleAddFundFormDE() {
                    const form = document.getElementById('addFundFormDE');
                    if (form.style.display === 'none') {
                        form.style.display = 'block';
                        // Clear form fields
                        document.getElementById('newFundNameDE').value = '';
                        document.getElementById('newFundTickerDE').value = '';
                        document.getElementById('newFundCategoryDE').value = '';
                        document.getElementById('newFundInceptionDE').value = '';
                    } else {
                        form.style.display = 'none';
                    }
                }
                
                // Delete fund
                function deleteFundDE(index) {
                    if (index < 0 || index >= fundsDE.length) {
                        showAlertDE('Invalid fund index!', 'error');
                        return;
                    }
                    
                    const fund = fundsDE[index];
                    if (confirm(`Delete "${fund.name}" (${fund.ticker})?\n\nThis will remove the fund from the table. You can always add it back later.`)) {
                        fundsDE.splice(index, 1);
                        initializeTableDE(true); // Preserve values of remaining funds
                        showAlertDE(`Fund "${fund.name}" deleted successfully!`, 'success');
                    }
                }
                
                // Save new fund
                function saveNewFundDE() {
                    const name = document.getElementById('newFundNameDE').value.trim();
                    const ticker = document.getElementById('newFundTickerDE').value.trim().toUpperCase();
                    const category = document.getElementById('newFundCategoryDE').value.trim();
                    const inception = document.getElementById('newFundInceptionDE').value.trim() || 'N/A';
                    
                    // Validation
                    if (!name) {
                        showAlertDE('Please enter a fund name!', 'error');
                        document.getElementById('newFundNameDE').focus();
                        return;
                    }
                    
                    if (!ticker) {
                        showAlertDE('Please enter a ticker symbol!', 'error');
                        document.getElementById('newFundTickerDE').focus();
                        return;
                    }
                    
                    if (!category) {
                        showAlertDE('Please select a category!', 'error');
                        document.getElementById('newFundCategoryDE').focus();
                        return;
                    }
                    
                    // Check for duplicate ticker
                    const existingFund = fundsDE.find(f => f.ticker.toUpperCase() === ticker);
                    if (existingFund) {
                        showAlertDE(`Ticker "${ticker}" already exists! (${existingFund.name})`, 'error');
                        return;
                    }
                    
                    // Add to funds array
                    fundsDE.push({
                        name: name,
                        ticker: ticker,
                        category: category,
                        inception: inception,
                        expense: '0.00',
                        ytd: '',
                        mo1: '',
                        mo3: '',
                        yr1: '',
                        yr3: '',
                        yr5: '',
                        yr10: ''
                    });
                    
                    // Refresh table (preserve existing values)
                    initializeTableDE(true);
                    
                    // Close form
                    toggleAddFundFormDE();
                    
                    // Show success message
                    showAlertDE(`‚úÖ Fund "${name}" (${ticker}) added successfully!`, 'success');
                    
                    // Scroll to the new fund (it will be at the bottom)
                    setTimeout(() => {
                        const table = document.querySelector('#dataentry-pane .fund-table');
                        if (table) {
                            const rows = table.querySelectorAll('tbody tr');
                            if (rows.length > 0) {
                                rows[rows.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }, 100);
                }
                
                // Initialize on load
                initializeTableDE();
            </script>
        </div>
        
        <!-- Portfolio History Tab -->
        <div id="history-pane" class="tab-pane" style="padding: 40px;">
            <h2 style="margin-bottom: 20px;">üìÅ My Portfolios & Datasets</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                <strong>üí° Flexible Tracking:</strong><br>
                Create portfolios for any purpose - monthly statements, custom watchlists, competitor funds, what-if scenarios, daily snapshots, etc.
            </div>
            <div class="month-selector" id="monthSelector">
                <button class="month-button" onclick="showAddMonthForm()">+ Add New Portfolio</button>
            </div>
            <div id="addMonthForm" style="display: none; background: white; padding: 30px; border-radius: 12px; border: 2px solid #2563eb; margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">Create New Portfolio</h3>
                <input type="text" id="newMonthName" placeholder="e.g., November 2025, My Watchlist, Tech Stocks, etc." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="createMonth()" style="flex: 1; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Create Portfolio</button>
                    <button onclick="hideAddMonthForm()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab (existing dashboard) -->
        <div id="dashboard-pane" class="tab-pane">

        <div class="dashboard">
            <!-- Stats Sub-Tabs -->
            <div class="stats-sub-tabs" style="position: relative;">
                <button class="stats-sub-tab active" onclick="switchStatsTab('all')">üìä All Info</button>
                <button class="stats-sub-tab" onclick="switchStatsTab('best')">üèÜ Best Performers</button>
                <button class="stats-sub-tab" onclick="switchStatsTab('worst')">üìâ Worst Performers</button>
                <button class="toggle-btn" onclick="toggleStatsSection()" id="statsToggleBtn" style="position: absolute; right: 0; margin: 0;">Hide</button>
            </div>
            
            <!-- All Stats Container -->
            <div id="allStatsContainer">
            <!-- All Info Tab -->
            <div id="stats-all" class="stats-tab-content active">
                <div class="stats-grid" id="statsGridAll"></div>
            </div>
            
            <!-- Best Performers Tab -->
            <div id="stats-best" class="stats-tab-content">
                <div class="stats-grid" id="statsGridBest"></div>
            </div>
            
            <!-- Worst Performers Tab -->
            <div id="stats-worst" class="stats-tab-content">
                <div class="stats-grid" id="statsGridWorst"></div>
            </div>
            </div>
            <!-- End All Stats Container -->
            
            <!-- Disclaimer -->
            <div class="section">
                <div class="section-title">
                    ‚ö†Ô∏è Important Disclaimer
                    <button class="toggle-btn" onclick="toggleSection('disclaimerContent')">Show</button>
                </div>
                <div class="section-content hidden" id="disclaimerContent">
                    <div class="disclaimer" style="margin: 0;">
                        <p>Past performance does not guarantee future results. The investment return and principal value will fluctuate. This analysis is for informational purposes only and should not be construed as investment advice. Please consult with a financial advisor before making investment decisions.</p>
                    </div>
                </div>
            </div>
            
            
            <!-- Table of Contents -->
            <div class="section" id="tocSection">
                <div class="section-title">
                    üìë Table of Contents
                    <button class="toggle-btn" onclick="toggleSection('tocContent')">Hide</button>
                </div>
                <div class="section-content" id="tocContent">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div class="fund-card" style="border-left-color: #e67e22;">
                            <h4 style="cursor: pointer; color: #e67e22; margin-bottom: 10px;" onclick="document.getElementById('searchContent').scrollIntoView({ behavior: 'smooth' })">
                                üîç Fund Search
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Quick fund finder</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #ea580c;">
                            <h4 style="cursor: pointer; color: #ea580c; margin-bottom: 10px;" onclick="document.getElementById('bestWorstContent').scrollIntoView({ behavior: 'smooth' })">
                                üèÜ Best/Worst Performers
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">By all time periods</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #2563eb;">
                            <h4 style="cursor: pointer; color: #2563eb; margin-bottom: 10px;" onclick="document.getElementById('hotFundsContent').scrollIntoView({ behavior: 'smooth' })">
                                üî• Hot Performers
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Top 6 funds by 1-year returns</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #3498db;">
                            <h4 style="cursor: pointer; color: #3498db; margin-bottom: 10px;" onclick="document.getElementById('coldFundsContent').scrollIntoView({ behavior: 'smooth' })">
                                ‚ùÑÔ∏è Cold Performers
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Bottom 6 funds by 1-year returns</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #9b59b6;">
                            <h4 style="cursor: pointer; color: #9b59b6; margin-bottom: 10px;" onclick="document.getElementById('portfolioOptContent').scrollIntoView({ behavior: 'smooth' })">
                                üéØ Portfolio Optimizer
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Maximize your returns</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #e91e63;">
                            <h4 style="cursor: pointer; color: #e91e63; margin-bottom: 10px;" onclick="document.getElementById('analyticsContent').scrollIntoView({ behavior: 'smooth' })">
                                üìä Advanced Analytics
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">6 powerful analysis charts</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #1e40af;">
                            <h4 style="cursor: pointer; color: #1e40af; margin-bottom: 10px;" onclick="document.getElementById('chartsContent').scrollIntoView({ behavior: 'smooth' })">
                                üìä Performance Comparison
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">YTD, 1yr vs 3yr, expense charts</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #f1c40f;">
                            <h4 style="cursor: pointer; color: #f1c40f; margin-bottom: 10px;" onclick="document.getElementById('consistencyContent').scrollIntoView({ behavior: 'smooth' })">
                                ‚≠ê Consistency Rankings
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Most reliable performers</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #dc2626;">
                            <h4 style="cursor: pointer; color: #dc2626; margin-bottom: 10px;" onclick="document.getElementById('categoryContent').scrollIntoView({ behavior: 'smooth' })">
                                üìà By Category
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Category performance analysis</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #ea580c;">
                            <h4 style="cursor: pointer; color: #ea580c; margin-bottom: 10px;" onclick="document.getElementById('tableContent').scrollIntoView({ behavior: 'smooth' })">
                                üìã Complete Listing
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Full fund table with filters</p>
                        </div>
                        
                        <div class="fund-card" style="border-left-color: #16a085;">
                            <h4 style="cursor: pointer; color: #16a085; margin-bottom: 10px;" onclick="document.getElementById('fundDiveContent').scrollIntoView({ behavior: 'smooth' })">
                                üîç Fund Deep Dive
                            </h4>
                            <p style="font-size: 0.85em; color: #64748b;">Detailed analysis & charts</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fund Search Section -->
            <div class="section" id="searchSection">
                <div class="section-title">
                    üîç Fund Search
                    <button class="toggle-btn" onclick="toggleSection('searchContent')">Hide</button>
                </div>
                <div class="section-content" id="searchContent">
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="fundSearchInput" placeholder="Type fund name to search..." 
                               style="width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #e0e0e0; border-radius: 10px; outline: none;"
                               onkeyup="searchFunds()">
                    </div>
                    <div id="searchResults" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
                </div>
            </div>
            
            <!-- Best/Worst Performers by All Time Periods -->
            <div class="section" id="bestWorstSection">
                <div class="section-title">
                    üèÜ Best/Worst Performers by All Time Periods
                    <button class="toggle-btn" onclick="toggleSection('bestWorstContent')">Hide</button>
                </div>
                <div class="section-content" id="bestWorstContent">
                    <!-- Best Performers -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #059669; margin-bottom: 15px; font-size: 1.3em;">üèÜ Best Performers</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">Click any tile to jump to the fund's detailed analysis</p>
                        <div id="bestPerformersGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                    </div>
                    
                    <!-- Worst Performers -->
                    <div>
                        <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 1.3em;">‚ö†Ô∏è Worst Performers</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">Click any tile to jump to the fund's detailed analysis</p>
                        <div id="worstPerformersGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Hot & Cold Funds -->
            <div class="section">
                <div class="section-title">
                    üî• Hot Performers (1-Year)
                    <button class="toggle-btn" onclick="toggleSection('hotFundsContent')">Hide</button>
                </div>
                <div class="section-content" id="hotFundsContent">
                    <div class="hot-cold-grid" id="hotFunds"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    ‚ùÑÔ∏è Cold Performers (1-Year)
                    <button class="toggle-btn" onclick="toggleSection('coldFundsContent')">Hide</button>
                </div>
                <div class="section-content" id="coldFundsContent">
                    <div class="hot-cold-grid" id="coldFunds"></div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="section">
                <div class="section-title">
                    üìä Performance Comparison
                    <button class="toggle-btn" onclick="toggleSection('chartsContent')">Hide</button>
                </div>
                <div class="section-content" id="chartsContent">
                    <div class="chart-container">
                        <div class="chart-title">
                            YTD Returns by Fund
                            <button class="toggle-btn" onclick="toggleSection('ytdChartContent')" style="float: right; font-size: 0.75em; padding: 5px 12px;">Hide</button>
                        </div>
                        <div id="ytdChartContent" style="position: relative; height: 600px;">
                            <canvas id="ytdChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            1-Year vs 3-Year Performance
                            <button class="toggle-btn" onclick="toggleSection('perfCompChartContent')" style="float: right; font-size: 0.75em; padding: 5px 12px;">Hide</button>
                        </div>
                        <div id="perfCompChartContent" style="position: relative; height: 500px;">
                            <canvas id="performanceComparisonChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            Expense Ratios Analysis
                            <button class="toggle-btn" onclick="toggleSection('expenseChartContent')" style="float: right; font-size: 0.75em; padding: 5px 12px;">Hide</button>
                        </div>
                        <div id="expenseChartContent" style="position: relative; height: 650px;">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            üéØ Custom Fund Comparison
                            <button class="toggle-btn" onclick="toggleSection('customCompContent')" style="float: right; font-size: 0.75em; padding: 5px 12px;">Hide</button>
                        </div>
                        <div id="customCompContent">
                            <p style="font-size: 0.9em; color: #64748b; margin-bottom: 15px;">Select multiple funds to compare their performance across all time periods</p>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">Select Funds to Compare:</label>
                                <div id="fundCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;"></div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button onclick="updateCustomComparison()" style="background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1em; flex: 1; max-width: 250px;">
                                        üìä Compare Selected Funds
                                    </button>
                                    <button onclick="clearCustomComparison()" style="background: #95a5a6; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1em;">
                                        üîÑ Clear Selection
                                    </button>
                                </div>
                            </div>
                            
                            <div id="customCompChartContainer" style="position: relative; height: 500px; display: none;">
                                <div class="chart-title">üìä Multi-Period Returns Comparison</div>
                                <p style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">Compare percentage returns across all time periods for selected funds</p>
                                <canvas id="customCompChart"></canvas>
                            </div>
                            <div id="customCompMessage" style="text-align: center; padding: 60px; color: #64748b; font-size: 1.1em;">
                                üëÜ Select at least 2 funds above to see the comparison chart
                            </div>
                            
                            <div id="custom10kChartContainer" style="position: relative; height: 600px; display: none; margin-top: 60px;">
                                <div class="chart-title">üí∞ Growth of $10,000 Investment</div>
                                <p style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">See what your $10,000 would be worth today if invested over each time period</p>
                                <canvas id="custom10kChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Category Performance -->
            <div class="section">
                <div class="section-title">
                    üìà Performance by Category
                    <button class="toggle-btn" onclick="toggleSection('categoryContent')">Hide</button>
                </div>
                <div class="section-content" id="categoryContent">
                    <div class="chart-container" style="position: relative; height: 650px;">
                        <div class="chart-title">üìä Average YTD Returns by Category</div>
                        <p style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">Average 1-year returns by category</p>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    
                    <div class="chart-container" style="position: relative; height: 700px; margin-top: 20px;">
                        <div class="chart-title">üìä Multi-Period Category Performance Comparison</div>
                        <p style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">Compare average returns across all time periods for each category</p>
                        <canvas id="categoryMultiPeriodChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- All Funds Table -->
            <div class="section">
                <div class="section-title">
                    üìã Complete Fund Listing
                    <button class="toggle-btn" onclick="toggleSection('tableContent')">Hide</button>
                </div>
                <div class="section-content" id="tableContent">
                    <div class="filter-buttons" id="filterButtons"></div>
                    <div style="overflow-x: auto;">
                        <table id="fundsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('name')" style="cursor: pointer;" id="th-name">Fund Name <span id="sort-name">‚áÖ</span></th>
                                    <th onclick="sortTable('category')" style="cursor: pointer;" id="th-category">Category <span id="sort-category">‚áÖ</span></th>
                                    <th onclick="sortTable('1_month')" style="cursor: pointer;" id="th-1_month">1 Mo % <span id="sort-1_month">‚áÖ</span></th>
                                    <th onclick="sortTable('3_month')" style="cursor: pointer;" id="th-3_month">3 Mo % <span id="sort-3_month">‚áÖ</span></th>
                                    <th onclick="sortTable('ytd')" style="cursor: pointer;" id="th-ytd">YTD % <span id="sort-ytd">‚áÖ</span></th>
                                    <th onclick="sortTable('1_year')" style="cursor: pointer;" id="th-1_year">1 Yr % <span id="sort-1_year">‚áÖ</span></th>
                                    <th onclick="sortTable('3_year')" style="cursor: pointer;" id="th-3_year">3 Yr % <span id="sort-3_year">‚áÖ</span></th>
                                    <th onclick="sortTable('5_year')" style="cursor: pointer;" id="th-5_year">5 Yr % <span id="sort-5_year">‚áÖ</span></th>
                                    <th onclick="sortTable('10_year')" style="cursor: pointer;" id="th-10_year">10 Yr % <span id="sort-10_year">‚áÖ</span></th>
                                    <th onclick="sortTable('inception')" style="cursor: pointer;" id="th-inception">Inception % <span id="sort-inception">‚áÖ</span></th>
                                    <th onclick="sortTable('net_expense')" style="cursor: pointer;" id="th-net_expense">Expense % <span id="sort-net_expense">‚áÖ</span></th>
                                </tr>
                            </thead>
                            <tbody id="fundsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Portfolio Optimizer Section -->
            <div class="section">
                <div class="section-title">
                    üéØ Portfolio Optimizer
                    <button class="toggle-btn" onclick="toggleSection('portfolioOptContent')">Hide</button>
                </div>
                <div class="section-content" id="portfolioOptContent">
                    
                    <!-- Top Performers by Category -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">üèÜ Best Performers by Category</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">These are the top-performing funds in each category based on 1-year returns. Consider allocating more to these winners.</p>
                        <div id="topPerformersByCategory" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;"></div>
                    </div>
                    
                    <!-- Worst Performers by Category -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">‚ö†Ô∏è Worst Performers by Category</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">These are the lowest-performing funds in each category based on 1-year returns. Consider reducing allocation or avoiding these.</p>
                        <div id="worstPerformersByCategory" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;"></div>
                    </div>
                    
                    <!-- Rebalancing Recommendations -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">üí° Smart Rebalancing Recommendations</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">Data-driven suggestions to maximize returns while managing costs.</p>
                        <div id="rebalancingRecs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 15px;"></div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Advanced Analytics Section -->
            <div class="section">
                <div class="section-title">
                    üìä Advanced Analytics Dashboard
                    <button class="toggle-btn" onclick="toggleSection('analyticsContent')">Hide</button>
                </div>
                <div class="section-content" id="analyticsContent">
                    
                    <!-- Advanced Analytics - 6 Charts in 2x2 Grid -->
                    <div style="margin-bottom: 30px;">
                        
                        <!-- Row 1: Risk-Adjusted Returns + Performance Momentum -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="chart-container">
                                <div class="chart-title">‚öñÔ∏è Risk-Adjusted Returns (Sharpe Ratio)</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Higher = Better return per unit of risk</p>
                                <div style="position: relative; height: 450px;">
                                    <canvas id="sharpeRatioChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">üöÄ Performance Momentum</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Green = Accelerating | Red = Decelerating</p>
                                <div style="position: relative; height: 450px;">
                                    <canvas id="momentumChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Category Heat Map + $10K Growth -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="chart-container">
                                <div class="chart-title">üî• Category Performance Heat Map</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Average 1-year returns by category</p>
                                <div style="position: relative; height: 450px;">
                                    <canvas id="heatMapChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">üìà $10K Growth Over 5 Years</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">See compound growth in action</p>
                                <div style="position: relative; height: 450px;">
                                    <canvas id="growthChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 3: Performance Spread (Full Width, Extra Tall) -->
                        <div style="margin-bottom: 20px;">
                            <div class="chart-container">
                                <div class="chart-title">üìä Performance Range by Category</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Best, Average, and Worst in each category</p>
                                <div style="position: relative; height: 600px;">
                                    <canvas id="spreadChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 4: Multi-Period Consistency -->
                        <div style="margin-bottom: 20px;">
                            <div class="chart-container">
                                <div class="chart-title">üéØ Multi-Period Consistency</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Most reliable performers across all periods</p>
                                <div style="position: relative; height: 450px;">
                                    <canvas id="rollingReturnsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Performance Charts Section -->
            <div class="section">
                <div class="section-title">
                    ‚≠ê Consistency Rankings
                    <button class="toggle-btn" onclick="toggleSection('consistencyContent')">Hide</button>
                </div>
                <div class="section-content" id="consistencyContent">
                    
                    <!-- Consistency Score -->
                    <div>
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">‚≠ê Consistency Rankings</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">Funds ranked by consistent performance across multiple time periods. Higher scores = more reliable returns.</p>
                        <div style="overflow-x: auto;">
                            <table id="consistencyTable" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th onclick="sortConsistencyTable('rank')" style="cursor: pointer;">Rank ‚áÖ</th>
                                        <th onclick="sortConsistencyTable('name')" style="cursor: pointer;">Fund Name ‚áÖ</th>
                                        <th onclick="sortConsistencyTable('score')" style="cursor: pointer;">Consistency Score ‚áÖ</th>
                                        <th onclick="sortConsistencyTable('avgReturn')" style="cursor: pointer;">Avg Return ‚áÖ</th>
                                        <th onclick="sortConsistencyTable('expense')" style="cursor: pointer;">Expense Ratio ‚áÖ</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="consistencyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Fund Deep Dive Section -->
            <div class="section">
                <div class="section-title">
                    üîç Fund Deep Dive
                    <button class="toggle-btn" onclick="toggleSection('fundDiveContent')">Hide</button>
                </div>
                <div class="section-content" id="fundDiveContent">
                    <div style="margin-bottom: 20px;">
                        <label for="fundSelect" style="font-weight: 600; margin-right: 10px;">Select Fund:</label>
                        <select id="fundSelect" style="padding: 10px 20px; border-radius: 8px; border: 2px solid #3498db; font-size: 1em; cursor: pointer;">
                            <option value="">-- Choose a fund --</option>
                        </select>
                    </div>
                    
                    <div id="fundDetails" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div class="fund-card">
                                <h4>üìä Fund Overview</h4>
                                <div class="performance-row">
                                    <span class="metric">Ticker Symbol:</span>
                                    <span class="value" id="detailTicker" style="font-family: monospace; font-weight: bold; font-size: 1.1em;"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">Inception Date:</span>
                                    <span class="value" id="detailInception"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">Category:</span>
                                    <span class="value" id="detailCategory"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">Unit Value:</span>
                                    <span class="value" id="detailUnitValue"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">Net Expense Ratio:</span>
                                    <span class="value" id="detailExpense"></span>
                                </div>
                            </div>
                            
                            <div class="fund-card">
                                <h4>üìà Recent Performance</h4>
                                <div class="performance-row">
                                    <span class="metric">1 Month:</span>
                                    <span class="value" id="detail1Mo"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">3 Month:</span>
                                    <span class="value" id="detail3Mo"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">Year to Date:</span>
                                    <span class="value" id="detailYTD"></span>
                                </div>
                            </div>
                            
                            <div class="fund-card">
                                <h4>‚è±Ô∏è Long-term Performance</h4>
                                <div class="performance-row">
                                    <span class="metric">1 Year:</span>
                                    <span class="value" id="detail1Yr"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">3 Year:</span>
                                    <span class="value" id="detail3Yr"></span>
                                </div>
                                <div class="performance-row">
                                    <span class="metric">5 Year:</span>
                                    <span class="value" id="detail5Yr"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- External Links Section - After Recent Performance -->
                        <div id="externalLinks" style="margin-bottom: 20px;"></div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="chart-container">
                                <div class="chart-title">üìä Performance Timeline</div>
                                <canvas id="fundTimelineChart" style="max-height: 180px;"></canvas>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">üìà Growth of $10,000</div>
                                <canvas id="fundGrowthChart" style="max-height: 180px;"></canvas>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="chart-container" id="holdingsContainer" style="display: none;">
                                <div class="chart-title">üè¢ Top 10 Holdings</div>
                                <canvas id="fundHoldingsChart" style="max-height: 200px;"></canvas>
                            </div>
                            
                            <div class="chart-container" id="sectorContainer" style="display: none;">
                                <div class="chart-title">üè≠ Sector Allocation</div>
                                <canvas id="fundSectorChart" style="max-height: 200px;"></canvas>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="chart-container" id="allocationContainer">
                                <div class="chart-title">üìä Performance Consistency</div>
                                <canvas id="fundConsistencyChart" style="max-height: 180px;"></canvas>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">üìâ Risk vs Return Analysis</div>
                                <p style="color: #64748b; font-size: 0.85em; margin-bottom: 15px;">Lower expense, higher return = better value</p>
                                <canvas id="riskReturnChart" style="max-height: 220px;"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="margin-top: 15px;">
                            <div class="chart-title">üí∞ Cost vs Performance</div>
                            <canvas id="costPerformanceChart" style="max-height: 300px;"></canvas>
                        </div>
                        
                        <div class="chart-container" style="margin-top: 15px;">
                            <div class="chart-title">üìä Category Comparison - Multi-Period Returns</div>
                            <p style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">Compare this fund against all other funds in the same category across time periods</p>
                            <canvas id="categoryComparisonChart" style="max-height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Investment Portfolio Analyzer</strong></p>
            <p>Investment Analysis Tool | Generated: <span id="generatedDate"></span></p>
            <p style="margin-top: 10px; font-size: 0.85em;">
                Data Source: Fund Performance Report | As of October 31, 2025
            </p>
        </div>
        
        <!-- Navigation Sidebar -->
        <div class="nav-sidebar">
            <button class="nav-sidebar-btn" onclick="scrollToTop()">
                üìÑ TOP
            </button>
            <button class="nav-sidebar-btn" onclick="scrollToTOC()">
                üìã TOC
            </button>
            <button class="nav-sidebar-btn" onclick="scrollToSearch()">
                üîç SEARCH
            </button>
        </div>
    </div>

    <script>
        // ===== PORTFOLIO MANAGEMENT - DECLARE FIRST AS GLOBAL =====
        window.monthsData = JSON.parse(localStorage.getItem('401k_months')) || {};
        window.currentMonthId = localStorage.getItem('401k_current_month') || null;
        window.categories = [];  // Will be populated from fund data
        
        // Make aliases directly equal to window properties (no let/const)
        var monthsData = window.monthsData;
        var currentMonthId = window.currentMonthId;
        var categories = window.categories;
        
        // ===== SORTING VARIABLES - GLOBAL =====
        window.currentSortColumn = 'ytd';
        window.currentSortDirection = 'desc';
        window.currentFilteredFunds = [];
        
        var currentSortColumn = window.currentSortColumn;
        var currentSortDirection = window.currentSortDirection;
        var currentFilteredFunds = window.currentFilteredFunds;

        function saveMonthsData() {
            localStorage.setItem('401k_months', JSON.stringify(window.monthsData));
            localStorage.setItem('401k_current_month', window.currentMonthId);
        }

        // ===== CHART CONFIGURATION =====
        // Configure Chart.js for crisp rendering on high-DPI displays
        Chart.defaults.devicePixelRatio = window.devicePixelRatio || 2;
        
        // Fund data - GLOBAL
        window.funds = [
            {"name": "Putnam Stable Value (25)", "ticker": "", "category": "Short Bonds/Stable/MMkt", "inception_date": "02/91", "unit_value": 1.0, "1_month": 0.36, "3_month": 1.01, "ytd": 3.23, "1_year": 3.82, "3_year": 3.57, "5_year": 3.05, "10_year": 2.58, "inception": 4.05, "gross_expense": 0.37, "net_expense": 0.37},
            {"name": "Allspring Core Plus Bond Inst", "ticker": "WIPIX", "category": "Interm./Long-Term Bonds", "inception_date": "07/98", "unit_value": 11.4, "1_month": 0.67, "3_month": 3.12, "ytd": 7.0, "1_year": 3.23, "3_year": 5.75, "5_year": 0.64, "10_year": 3.18, "inception": 4.37, "gross_expense": 0.49, "net_expense": 0.35},
            {"name": "Vanguard Equity-Income Adm", "ticker": "VEIRX", "category": "Large-Cap Stocks", "inception_date": "03/88", "unit_value": 97.82, "1_month": -0.17, "3_month": 5.25, "ytd": 13.0, "1_year": 12.36, "3_year": 16.97, "5_year": 14.83, "10_year": 12.11, "inception": 8.95, "gross_expense": 0.18, "net_expense": 0.18},
            {"name": "Vanguard Total Stock Mkt Idx Adm", "ticker": "VTSAX", "category": "Large-Cap Stocks", "inception_date": "04/92", "unit_value": 163.24, "1_month": 2.18, "3_month": 8.13, "ytd": 16.82, "1_year": 17.33, "3_year": 24.07, "5_year": 15.65, "10_year": 14.66, "inception": 8.83, "gross_expense": 0.04, "net_expense": 0.04},
            {"name": "Federated Hermes MDT Large Cap Growth IS", "ticker": "QILGX", "category": "Large-Cap Stocks", "inception_date": "09/05", "unit_value": 44.36, "1_month": 3.33, "3_month": 8.27, "ytd": 20.31, "1_year": 23.59, "3_year": 32.37, "5_year": 19.41, "10_year": 18.81, "inception": 12.38, "gross_expense": 0.87, "net_expense": 0.75},
            {"name": "American Century Mid Cap Value R6", "ticker": "AMDVX", "category": "Small/Mid-Cap Stocks", "inception_date": "03/04", "unit_value": 16.34, "1_month": -2.33, "3_month": 1.77, "ytd": 6.55, "1_year": 6.15, "3_year": 12.88, "5_year": 12.55, "10_year": 9.88, "inception": 9.59, "gross_expense": 0.62, "net_expense": 0.62},
            {"name": "T. Rowe Price Diversified Mid Cap Gr I", "ticker": "RPTTX", "category": "Small/Mid-Cap Stocks", "inception_date": "12/03", "unit_value": 52.39, "1_month": 0.06, "3_month": 0.87, "ytd": 14.09, "1_year": 22.67, "3_year": 21.93, "5_year": 11.95, "10_year": 13.86, "inception": 13.79, "gross_expense": 0.67, "net_expense": 0.67},
            {"name": "DFA US Targeted Value I", "ticker": "DFFVX", "category": "Small/Mid-Cap Stocks", "inception_date": "02/00", "unit_value": 35.32, "1_month": -2.11, "3_month": 5.4, "ytd": 4.25, "1_year": 7.5, "3_year": 16.09, "5_year": 19.55, "10_year": 10.72, "inception": 10.98, "gross_expense": 0.3, "net_expense": 0.29},
            {"name": "AB Small Cap Growth I", "ticker": "QUAIX", "category": "Small/Mid-Cap Stocks", "inception_date": "02/69", "unit_value": 77.11, "1_month": 2.36, "3_month": 6.31, "ytd": 5.47, "1_year": 3.01, "3_year": 14.23, "5_year": 4.17, "10_year": 11.84, "inception": 10.23, "gross_expense": 0.87, "net_expense": 0.87},
            {"name": "American Funds EUPAC R6", "ticker": "RERGX", "category": "International Stocks", "inception_date": "05/09", "unit_value": 66.39, "1_month": 2.88, "3_month": 10.89, "ytd": 27.04, "1_year": 14.79, "3_year": 19.65, "5_year": 7.49, "10_year": 8.28, "inception": 8.67, "gross_expense": 0.47, "net_expense": 0.47},
            {"name": "Cullen Emerging Markets High Div I", "ticker": "CEMFX", "category": "International Stocks", "inception_date": "08/12", "unit_value": 16.2, "1_month": 3.71, "3_month": 14.24, "ytd": 30.36, "1_year": 21.86, "3_year": 24.52, "5_year": 14.37, "10_year": 9.41, "inception": 7.0, "gross_expense": 1.22, "net_expense": 1.0},
            {"name": "Vanguard Target Retirement Income Inv", "ticker": "VTINX", "category": "Multi-Asset/Other", "inception_date": "10/03", "unit_value": 14.21, "1_month": 1.07, "3_month": 4.29, "ytd": 10.78, "1_year": 7.89, "3_year": 10.3, "5_year": 4.55, "10_year": 5.29, "inception": 5.21, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2020 Inv", "ticker": "VTWNX", "category": "Multi-Asset/Other", "inception_date": "06/06", "unit_value": 29.54, "1_month": 1.1, "3_month": 4.6, "ytd": 11.56, "1_year": 8.59, "3_year": 11.98, "5_year": 6.03, "10_year": 6.99, "inception": 6.31, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2025 Inv", "ticker": "VTTVX", "category": "Multi-Asset/Other", "inception_date": "10/03", "unit_value": 21.27, "1_month": 1.29, "3_month": 5.56, "ytd": 13.8, "1_year": 10.52, "3_year": 14.31, "5_year": 7.38, "10_year": 7.99, "inception": 7.0, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2030 Inv", "ticker": "VTHRX", "category": "Multi-Asset/Other", "inception_date": "06/06", "unit_value": 43.67, "1_month": 1.46, "3_month": 6.28, "ytd": 15.29, "1_year": 11.7, "3_year": 15.92, "5_year": 8.5, "10_year": 8.78, "inception": 7.22, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2035 Inv", "ticker": "VTTHX", "category": "Multi-Asset/Other", "inception_date": "10/03", "unit_value": 27.93, "1_month": 1.56, "3_month": 6.77, "ytd": 16.47, "1_year": 12.84, "3_year": 17.29, "5_year": 9.56, "10_year": 9.55, "inception": 7.93, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2040 Inv", "ticker": "VFORX", "category": "Multi-Asset/Other", "inception_date": "06/06", "unit_value": 50.8, "1_month": 1.64, "3_month": 7.22, "ytd": 17.54, "1_year": 13.9, "3_year": 18.67, "5_year": 10.62, "10_year": 10.3, "inception": 8.03, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2045 Inv", "ticker": "VTIVX", "category": "Multi-Asset/Other", "inception_date": "10/03", "unit_value": 35.21, "1_month": 1.73, "3_month": 7.71, "ytd": 18.67, "1_year": 14.94, "3_year": 20.02, "5_year": 11.66, "10_year": 10.89, "inception": 8.71, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2050 Inv", "ticker": "VFIFX", "category": "Multi-Asset/Other", "inception_date": "06/06", "unit_value": 59.79, "1_month": 1.82, "3_month": 8.18, "ytd": 19.96, "1_year": 16.08, "3_year": 21.03, "5_year": 12.2, "10_year": 11.16, "inception": 8.49, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2055 Inv", "ticker": "VFFVX", "category": "Multi-Asset/Other", "inception_date": "08/10", "unit_value": 66.71, "1_month": 1.82, "3_month": 8.19, "ytd": 19.96, "1_year": 16.07, "3_year": 21.03, "5_year": 12.2, "10_year": 11.15, "inception": 10.77, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2060 Inv", "ticker": "VTTSX", "category": "Multi-Asset/Other", "inception_date": "01/12", "unit_value": 61.48, "1_month": 1.82, "3_month": 8.2, "ytd": 19.96, "1_year": 16.05, "3_year": 21.03, "5_year": 12.2, "10_year": 11.15, "inception": 10.65, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2065 Inv", "ticker": "VLXVX", "category": "Multi-Asset/Other", "inception_date": "07/17", "unit_value": 40.34, "1_month": 1.84, "3_month": 8.21, "ytd": 19.99, "1_year": 16.02, "3_year": 21.02, "5_year": 12.2, "10_year": null, "inception": 10.55, "gross_expense": 0.08, "net_expense": 0.08},
            {"name": "Vanguard Target Retirement 2070 Inv", "ticker": "VSVNX", "category": "Multi-Asset/Other", "inception_date": "06/22", "unit_value": 32.0, "1_month": 1.81, "3_month": 8.18, "ytd": 19.94, "1_year": 16.0, "3_year": 21.03, "5_year": null, "10_year": null, "inception": 16.39, "gross_expense": 0.08, "net_expense": 0.08}
        ];
        
        // Make funds globally accessible (use var for true global scope)
        var funds = window.funds;

        // Function to update all statistics and displays
        function updateStats() {
            try {
                console.log('=== updateStats called ===');
                console.log('window.funds:', window.funds);
                console.log('Type:', typeof window.funds);
                console.log('Is Array?', Array.isArray(window.funds));
                console.log('Length:', window.funds?.length);
                
                // Safety check: ensure window.funds exists and is an array
                if (!window.funds) {
                    console.error('window.funds is null or undefined!');
                    return;
                }
                
                if (!Array.isArray(window.funds)) {
                    console.error('window.funds is not an array! Type:', typeof window.funds);
                    console.error('Value:', window.funds);
                    return;
                }
                
                if (window.funds.length === 0) {
                    console.log('No funds data available yet (empty array)');
                    return;
                }
                
                // Always reference the current window.funds
                const funds = window.funds;
                console.log('updateStats called with', funds.length, 'funds');
                
                // Additional validation
                if (!funds[0] || typeof funds[0] !== 'object') {
                    console.error('Invalid fund data structure');
                    return;
                }
                
                console.log('Sample fund YTD:', funds[0]?.ytd);
            
            // Analytics calculations
            const sortedBy1Year = [...funds].sort((a, b) => b["1_year"] - a["1_year"]);
            const hotFunds = sortedBy1Year.slice(0, 6);
            const coldFunds = sortedBy1Year.slice(-6).reverse();
            
            const sortedByYTD = [...funds].sort((a, b) => b.ytd - a.ytd); // For YTD chart
            
            const avgYTD = funds.reduce((sum, f) => sum + f.ytd, 0) / funds.length;
            const avg1Year = funds.reduce((sum, f) => sum + f["1_year"], 0) / funds.length;
            const avgExpense = funds.reduce((sum, f) => sum + f.net_expense, 0) / funds.length;
            const best1MonthValue = Math.max(...funds.map(f => f["1_month"]));
            const best3MonthValue = Math.max(...funds.map(f => f["3_month"]));
            const bestYTDValue = Math.max(...funds.map(f => f.ytd));
            const best1YearValue = Math.max(...funds.map(f => f["1_year"]));
            const best5YearValue = Math.max(...funds.filter(f => f["5_year"]).map(f => f["5_year"]));
            
            // Define funds10Year BEFORE using it
            const funds10Year = funds.filter(f => f['10_year'] && f['10_year'] > 0);
            const best10YearValue = funds10Year.length > 0 ? Math.max(...funds10Year.map(f => f["10_year"])) : 0;
            
            const lowestExpense = Math.min(...funds.map(f => f.net_expense));
            const best3Year = Math.max(...funds.filter(f => f["3_year"]).map(f => f["3_year"]));
            
            // Find best performers for each period (fund objects for tiles)
            const best1Month = funds.reduce((max, f) => f['1_month'] > max['1_month'] ? f : max);
            const best3Month = funds.reduce((max, f) => f['3_month'] > max['3_month'] ? f : max);
            const bestYTD = funds.reduce((max, f) => f.ytd > max.ytd ? f : max);
            const best1YearFund = funds.reduce((max, f) => f['1_year'] > max['1_year'] ? f : max);
            
            // Safety checks for optional fields that might be empty
            const funds3Year = funds.filter(f => f['3_year'] && f['3_year'] > 0);
            const best3YearFund = funds3Year.length > 0 ? funds3Year.reduce((max, f) => f['3_year'] > max['3_year'] ? f : max) : funds[0];
            
            const funds5Year = funds.filter(f => f['5_year'] && f['5_year'] > 0);
            const best5YearFund = funds5Year.length > 0 ? funds5Year.reduce((max, f) => f['5_year'] > max['5_year'] ? f : max) : funds[0];
            
            const best10YearFund = funds10Year.length > 0 ? funds10Year.reduce((max, f) => f['10_year'] > max['10_year'] ? f : max) : funds[0];
            
            // Find worst performers for each period
            const worst1Month = funds.reduce((min, f) => f['1_month'] < min['1_month'] ? f : min);
            const worst3Month = funds.reduce((min, f) => f['3_month'] < min['3_month'] ? f : min);
            const worstYTD = funds.reduce((min, f) => f.ytd < min.ytd ? f : min);
            const worst1YearFund = funds.reduce((min, f) => f['1_year'] < min['1_year'] ? f : min);
            const worst3YearFund = funds3Year.length > 0 ? funds3Year.reduce((min, f) => f['3_year'] < min['3_year'] ? f : min) : funds[0];
            const worst5YearFund = funds5Year.length > 0 ? funds5Year.reduce((min, f) => f['5_year'] < min['5_year'] ? f : min) : funds[0];
            const worst10YearFund = funds10Year.length > 0 ? funds10Year.reduce((min, f) => f['10_year'] < min['10_year'] ? f : min) : funds[0];
            
            // Find lowest expense fund
            const lowestExpenseFund = funds.reduce((min, f) => f.net_expense < min.net_expense ? f : min);

            // Calculate worst performers for WORST tab
            const worst1MonthValue = Math.min(...funds.map(f => f["1_month"]));
            const worst3MonthValue = Math.min(...funds.map(f => f["3_month"]));
            const worstYTDValue = Math.min(...funds.map(f => f.ytd));
            const worst1YearValue = Math.min(...funds.map(f => f["1_year"]));
            const worst3YearValue = funds3Year.length > 0 ? Math.min(...funds3Year.map(f => f["3_year"])) : 0;
            const worst5YearValue = funds5Year.length > 0 ? Math.min(...funds5Year.map(f => f["5_year"])) : 0;
            const worst10YearValue = funds10Year.length > 0 ? Math.min(...funds10Year.map(f => f["10_year"])) : 0;
            const highestExpense = Math.max(...funds.map(f => f.net_expense));
            const highestExpenseFund = funds.reduce((max, f) => f.net_expense > max.net_expense ? f : max);
            
            // Render stats - ALL INFO TAB (all 12 original boxes + worst performers)
            const statsGridAll = document.getElementById('statsGridAll');
        statsGridAll.innerHTML = `
            <div class="stat-card">
                <h3>Total Funds</h3>
                <div class="value">${funds.length}</div>
                <div class="label">Available Options</div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best1Month.name)})" style="cursor: pointer;">
                <h3>üî• Best 1-Month Return</h3>
                <div class="value">${best1MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best1Month.name.length > 25 ? best1Month.name.substring(0, 22) + '...' : best1Month.name}
                    ${best1Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best1Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best3Month.name)})" style="cursor: pointer;">
                <h3>üî• Best 3-Month Return</h3>
                <div class="value">${best3MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best3Month.name.length > 25 ? best3Month.name.substring(0, 22) + '...' : best3Month.name}
                    ${best3Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best3Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card">
                <h3>Average YTD Return</h3>
                <div class="value">${avgYTD.toFixed(2)}%</div>
                <div class="label">Across All Funds</div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === bestYTD.name)})" style="cursor: pointer;">
                <h3>üî• Best YTD Return</h3>
                <div class="value">${bestYTDValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${bestYTD.name.length > 25 ? bestYTD.name.substring(0, 22) + '...' : bestYTD.name}
                    ${bestYTD.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${bestYTD.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card">
                <h3>Average 1-Year Return</h3>
                <div class="value">${avg1Year.toFixed(2)}%</div>
                <div class="label">Across All Funds</div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best1YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 1-Year Return</h3>
                <div class="value">${best1YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best1YearFund.name.length > 25 ? best1YearFund.name.substring(0, 22) + '...' : best1YearFund.name}
                    ${best1YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best1YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best3YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 3-Year Return</h3>
                <div class="value">${best3Year.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best3YearFund.name.length > 25 ? best3YearFund.name.substring(0, 22) + '...' : best3YearFund.name}
                    ${best3YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best3YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best5YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 5-Year Return</h3>
                <div class="value">${best5YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best5YearFund.name.length > 25 ? best5YearFund.name.substring(0, 22) + '...' : best5YearFund.name}
                    ${best5YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best5YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" ${funds10Year.length > 0 ? `onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best10YearFund.name)})" style="cursor: pointer;"` : ''}>
                <h3>üî• Best 10-Year Return</h3>
                <div class="value">${funds10Year.length > 0 ? best10YearValue.toFixed(2) + '%' : 'N/A'}</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${funds10Year.length > 0 ? (best10YearFund.name.length > 25 ? best10YearFund.name.substring(0, 22) + '...' : best10YearFund.name) : 'No Data'}
                    ${funds10Year.length > 0 && best10YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best10YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card">
                <h3>Average Expense Ratio</h3>
                <div class="value">${avgExpense.toFixed(2)}%</div>
                <div class="label">Net Expenses</div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === lowestExpenseFund.name)})" style="cursor: pointer;">
                <h3>üí∞ Lowest Expense</h3>
                <div class="value">${lowestExpense.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${lowestExpenseFund.name.length > 25 ? lowestExpenseFund.name.substring(0, 22) + '...' : lowestExpenseFund.name}
                    ${lowestExpenseFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${lowestExpenseFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst1Month.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 1-Month Return</h3>
                <div class="value">${worst1MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst1Month.name.length > 25 ? worst1Month.name.substring(0, 22) + '...' : worst1Month.name}
                    ${worst1Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst1Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst3Month.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 3-Month Return</h3>
                <div class="value">${worst3MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst3Month.name.length > 25 ? worst3Month.name.substring(0, 22) + '...' : worst3Month.name}
                    ${worst3Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst3Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worstYTD.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst YTD Return</h3>
                <div class="value">${worstYTDValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worstYTD.name.length > 25 ? worstYTD.name.substring(0, 22) + '...' : worstYTD.name}
                    ${worstYTD.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worstYTD.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst1YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 1-Year Return</h3>
                <div class="value">${worst1YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst1YearFund.name.length > 25 ? worst1YearFund.name.substring(0, 22) + '...' : worst1YearFund.name}
                    ${worst1YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst1YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst3YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 3-Year Return</h3>
                <div class="value">${worst3YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst3YearFund.name.length > 25 ? worst3YearFund.name.substring(0, 22) + '...' : worst3YearFund.name}
                    ${worst3YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst3YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst5YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 5-Year Return</h3>
                <div class="value">${worst5YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst5YearFund.name.length > 25 ? worst5YearFund.name.substring(0, 22) + '...' : worst5YearFund.name}
                    ${worst5YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst5YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" ${funds10Year.length > 0 ? `onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst10YearFund.name)})" style="cursor: pointer;"` : ''}>
                <h3>‚ùÑÔ∏è Worst 10-Year Return</h3>
                <div class="value">${funds10Year.length > 0 ? worst10YearValue.toFixed(2) + '%' : 'N/A'}</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${funds10Year.length > 0 ? (worst10YearFund.name.length > 25 ? worst10YearFund.name.substring(0, 22) + '...' : worst10YearFund.name) : 'No Data'}
                    ${funds10Year.length > 0 && worst10YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst10YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === highestExpenseFund.name)})" style="cursor: pointer;">
                <h3>‚ö†Ô∏è Highest Expense</h3>
                <div class="value">${highestExpense.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${highestExpenseFund.name.length > 25 ? highestExpenseFund.name.substring(0, 22) + '...' : highestExpenseFund.name}
                    ${highestExpenseFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${highestExpenseFund.ticker}</div>` : ''}
                </div>
            </div>
        `;
        
        // Render stats - BEST PERFORMERS TAB
        const statsGridBest = document.getElementById('statsGridBest');
        statsGridBest.innerHTML = `
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best1Month.name)})" style="cursor: pointer;">
                <h3>üî• Best 1-Month Return</h3>
                <div class="value">${best1MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best1Month.name.length > 25 ? best1Month.name.substring(0, 22) + '...' : best1Month.name}
                    ${best1Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best1Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best3Month.name)})" style="cursor: pointer;">
                <h3>üî• Best 3-Month Return</h3>
                <div class="value">${best3MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best3Month.name.length > 25 ? best3Month.name.substring(0, 22) + '...' : best3Month.name}
                    ${best3Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best3Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === bestYTD.name)})" style="cursor: pointer;">
                <h3>üî• Best YTD Return</h3>
                <div class="value">${bestYTDValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${bestYTD.name.length > 25 ? bestYTD.name.substring(0, 22) + '...' : bestYTD.name}
                    ${bestYTD.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${bestYTD.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best1YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 1-Year Return</h3>
                <div class="value">${best1YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best1YearFund.name.length > 25 ? best1YearFund.name.substring(0, 22) + '...' : best1YearFund.name}
                    ${best1YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best1YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best3YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 3-Year Return</h3>
                <div class="value">${best3Year.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best3YearFund.name.length > 25 ? best3YearFund.name.substring(0, 22) + '...' : best3YearFund.name}
                    ${best3YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best3YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best5YearFund.name)})" style="cursor: pointer;">
                <h3>üî• Best 5-Year Return</h3>
                <div class="value">${best5YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${best5YearFund.name.length > 25 ? best5YearFund.name.substring(0, 22) + '...' : best5YearFund.name}
                    ${best5YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best5YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" ${funds10Year.length > 0 ? `onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === best10YearFund.name)})" style="cursor: pointer;"` : ''}>
                <h3>üî• Best 10-Year Return</h3>
                <div class="value">${funds10Year.length > 0 ? best10YearValue.toFixed(2) + '%' : 'N/A'}</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${funds10Year.length > 0 ? (best10YearFund.name.length > 25 ? best10YearFund.name.substring(0, 22) + '...' : best10YearFund.name) : 'No Data'}
                    ${funds10Year.length > 0 && best10YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${best10YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === lowestExpenseFund.name)})" style="cursor: pointer;">
                <h3>üí∞ Lowest Expense</h3>
                <div class="value">${lowestExpense.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${lowestExpenseFund.name.length > 25 ? lowestExpenseFund.name.substring(0, 22) + '...' : lowestExpenseFund.name}
                    ${lowestExpenseFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${lowestExpenseFund.ticker}</div>` : ''}
                </div>
            </div>
        `;
        
        const statsGridWorst = document.getElementById('statsGridWorst');
        statsGridWorst.innerHTML = `
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst1Month.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 1-Month Return</h3>
                <div class="value">${worst1MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst1Month.name.length > 25 ? worst1Month.name.substring(0, 22) + '...' : worst1Month.name}
                    ${worst1Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst1Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst3Month.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 3-Month Return</h3>
                <div class="value">${worst3MonthValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst3Month.name.length > 25 ? worst3Month.name.substring(0, 22) + '...' : worst3Month.name}
                    ${worst3Month.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst3Month.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worstYTD.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst YTD Return</h3>
                <div class="value">${worstYTDValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worstYTD.name.length > 25 ? worstYTD.name.substring(0, 22) + '...' : worstYTD.name}
                    ${worstYTD.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worstYTD.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst1YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 1-Year Return</h3>
                <div class="value">${worst1YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst1YearFund.name.length > 25 ? worst1YearFund.name.substring(0, 22) + '...' : worst1YearFund.name}
                    ${worst1YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst1YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst3YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 3-Year Return</h3>
                <div class="value">${worst3YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst3YearFund.name.length > 25 ? worst3YearFund.name.substring(0, 22) + '...' : worst3YearFund.name}
                    ${worst3YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst3YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst5YearFund.name)})" style="cursor: pointer;">
                <h3>‚ùÑÔ∏è Worst 5-Year Return</h3>
                <div class="value">${worst5YearValue.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${worst5YearFund.name.length > 25 ? worst5YearFund.name.substring(0, 22) + '...' : worst5YearFund.name}
                    ${worst5YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst5YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" ${funds10Year.length > 0 ? `onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === worst10YearFund.name)})" style="cursor: pointer;"` : ''}>
                <h3>‚ùÑÔ∏è Worst 10-Year Return</h3>
                <div class="value">${funds10Year.length > 0 ? worst10YearValue.toFixed(2) + '%' : 'N/A'}</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${funds10Year.length > 0 ? (worst10YearFund.name.length > 25 ? worst10YearFund.name.substring(0, 22) + '...' : worst10YearFund.name) : 'No Data'}
                    ${funds10Year.length > 0 && worst10YearFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${worst10YearFund.ticker}</div>` : ''}
                </div>
            </div>
            <div class="stat-card-worst" onclick="jumpToFundDeepDive(${funds.findIndex(f => f.name === highestExpenseFund.name)})" style="cursor: pointer;">
                <h3>‚ö†Ô∏è Highest Expense</h3>
                <div class="value">${highestExpense.toFixed(2)}%</div>
                <div class="label" style="color: #ffffff; font-weight: 700; font-size: 0.95em; text-shadow: 0 1px 2px rgba(0,0,0,0.3); line-height: 1.3;">
                    ${highestExpenseFund.name.length > 25 ? highestExpenseFund.name.substring(0, 22) + '...' : highestExpenseFund.name}
                    ${highestExpenseFund.ticker ? `<div style="font-size: 0.9em; margin-top: 3px; opacity: 0.95;">${highestExpenseFund.ticker}</div>` : ''}
                </div>
            </div>
        `;

        // Render Best Performers Tiles
        const bestPerformersGrid = document.getElementById('bestPerformersGrid');
        const bestPerformers = [
            { period: '1 Month', fund: best1Month, value: best1Month['1_month'], color: '#3498db' },
            { period: '3 Month', fund: best3Month, value: best3Month['3_month'], color: '#9b59b6' },
            { period: 'YTD', fund: bestYTD, value: bestYTD.ytd, color: '#e67e22' },
            { period: '1 Year', fund: best1YearFund, value: best1YearFund['1_year'], color: '#dc2626' },
            { period: '3 Year', fund: best3YearFund, value: best3YearFund['3_year'], color: '#059669' },
            { period: '5 Year', fund: best5YearFund, value: best5YearFund['5_year'], color: '#16a085' },
            { period: '10 Year', fund: best10YearFund, value: best10YearFund['10_year'], color: '#2980b9' }
        ];
        
        bestPerformersGrid.innerHTML = bestPerformers.map(item => {
            const fundIndex = funds.findIndex(f => f.name === item.fund.name);
            return `
                <div class="fund-card" onclick="jumpToFundDeepDive(${fundIndex})" style="cursor: pointer; padding: 15px; border-left: 4px solid ${item.color}; transition: all 0.3s ease;">
                    <div style="font-size: 0.75em; font-weight: 600; color: ${item.color}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${item.period}
                    </div>
                    <div style="font-size: 1.8em; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                        ${item.value.toFixed(2)}%
                    </div>
                    <div style="font-size: 0.85em; color: #64748b; line-height: 1.3;">
                        ${item.fund.name.length > 30 ? item.fund.name.substring(0, 27) + '...' : item.fund.name}
                    </div>
                    ${item.fund.ticker ? `<div style="font-family: monospace; font-weight: bold; color: ${item.color}; font-size: 0.8em; margin-top: 5px;">${item.fund.ticker}</div>` : ''}
                </div>
            `;
        }).join('');

        // Render Worst Performers Tiles
        const worstPerformersGrid = document.getElementById('worstPerformersGrid');
        const worstPerformers = [
            { period: '1 Month', fund: worst1Month, value: worst1Month['1_month'], color: '#95a5a6' },
            { period: '3 Month', fund: worst3Month, value: worst3Month['3_month'], color: '#64748b' },
            { period: 'YTD', fund: worstYTD, value: worstYTD.ytd, color: '#34495e' },
            { period: '1 Year', fund: worst1YearFund, value: worst1YearFund['1_year'], color: '#dc2626' },
            { period: '3 Year', fund: worst3YearFund, value: worst3YearFund['3_year'], color: '#c0392b' },
            { period: '5 Year', fund: worst5YearFund, value: worst5YearFund['5_year'], color: '#8e44ad' },
            { period: '10 Year', fund: worst10YearFund, value: worst10YearFund['10_year'], color: '#2c3e50' }
        ];
        
        worstPerformersGrid.innerHTML = worstPerformers.map(item => {
            const fundIndex = funds.findIndex(f => f.name === item.fund.name);
            return `
                <div class="fund-card" onclick="jumpToFundDeepDive(${fundIndex})" style="cursor: pointer; padding: 15px; border-left: 4px solid ${item.color}; transition: all 0.3s ease;">
                    <div style="font-size: 0.75em; font-weight: 600; color: ${item.color}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${item.period}
                    </div>
                    <div style="font-size: 1.8em; font-weight: bold; color: ${item.value < 0 ? '#dc2626' : '#2c3e50'}; margin-bottom: 8px;">
                        ${item.value.toFixed(2)}%
                    </div>
                    <div style="font-size: 0.85em; color: #64748b; line-height: 1.3;">
                        ${item.fund.name.length > 30 ? item.fund.name.substring(0, 27) + '...' : item.fund.name}
                    </div>
                    ${item.fund.ticker ? `<div style="font-family: monospace; font-weight: bold; color: ${item.color}; font-size: 0.8em; margin-top: 5px;">${item.fund.ticker}</div>` : ''}
                </div>
            `;
        }).join('');

        // Render hot funds
        const hotFundsDiv = document.getElementById('hotFunds');
        hotFundsDiv.innerHTML = hotFunds.map((fund, idx) => {
            const fundIndex = funds.findIndex(f => f.name === fund.name);
            return `
            <div class="fund-card hot" style="padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 class="fund-link" onclick="jumpToFundDeepDive(${fundIndex})" style="margin: 0; flex: 1; font-size: 1em;">
                        ${fund.name}
                    </h4>
                    <span class="badge hot" style="flex-shrink: 0; padding: 4px 10px; font-size: 0.7em;">üî• HOT</span>
                </div>
                ${fund.ticker ? `<div style="font-family: monospace; font-weight: bold; color: #dc2626; margin-bottom: 6px; font-size: 0.9em;">${fund.ticker}</div>` : ''}
                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 8px;">${fund.category}</div>
                
                <!-- Short-term Returns -->
                <div style="margin-top: 8px;">
                    <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Short-term</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">1 Mo:</span>
                            <span class="${fund['1_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['1_month'].toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">3 Mo:</span>
                            <span class="${fund['3_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['3_month'].toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">YTD:</span>
                            <span class="positive" style="font-weight: 600;">${fund.ytd.toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">1 Yr:</span>
                            <span class="positive" style="font-weight: 600;">${fund["1_year"].toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Long-term Returns -->
                <div style="margin-top: 10px;">
                    <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Long-term</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">3 Yr:</span>
                            <span class="${fund["3_year"] ? (fund["3_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["3_year"] ? fund["3_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">5 Yr:</span>
                            <span class="${fund["5_year"] ? (fund["5_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["5_year"] ? fund["5_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">10 Yr:</span>
                            <span class="${fund["10_year"] ? (fund["10_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["10_year"] ? fund["10_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">Incept Date:</span>
                            <span class="" style="font-weight: 600;">${fund.inception_date || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cost -->
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ecf0f1;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 4px;">
                        <span style="color: #64748b;">Incept %:</span>
                        <span class="${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                        <span style="color: #64748b;">Expense:</span>
                        <span class="${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}" style="font-weight: 600;">${fund.net_expense.toFixed(2)}%</span>
                    </div>
                </div>
            </div>
        `}).join('');

        // Render cold funds
        const coldFundsDiv = document.getElementById('coldFunds');
        coldFundsDiv.innerHTML = coldFunds.map((fund, idx) => {
            const fundIndex = funds.findIndex(f => f.name === fund.name);
            return `
            <div class="fund-card cold" style="padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 class="fund-link" onclick="jumpToFundDeepDive(${fundIndex})" style="margin: 0; flex: 1; font-size: 1em;">
                        ${fund.name}
                    </h4>
                    <span class="badge cold" style="flex-shrink: 0; padding: 4px 10px; font-size: 0.7em;">‚ùÑÔ∏è COLD</span>
                </div>
                ${fund.ticker ? `<div style="font-family: monospace; font-weight: bold; color: #3498db; margin-bottom: 6px; font-size: 0.9em;">${fund.ticker}</div>` : ''}
                <div style="color: #64748b; font-size: 0.85em; margin-bottom: 8px;">${fund.category}</div>
                
                <!-- Short-term Returns -->
                <div style="margin-top: 8px;">
                    <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Short-term</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">1 Mo:</span>
                            <span class="${fund['1_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['1_month'].toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">3 Mo:</span>
                            <span class="${fund['3_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['3_month'].toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">YTD:</span>
                            <span class="${fund.ytd >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund.ytd.toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">1 Yr:</span>
                            <span class="${fund["1_year"] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund["1_year"].toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Long-term Returns -->
                <div style="margin-top: 10px;">
                    <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Long-term</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">3 Yr:</span>
                            <span class="${fund["3_year"] ? (fund["3_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["3_year"] ? fund["3_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">5 Yr:</span>
                            <span class="${fund["5_year"] ? (fund["5_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["5_year"] ? fund["5_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">10 Yr:</span>
                            <span class="${fund["10_year"] ? (fund["10_year"] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund["10_year"] ? fund["10_year"].toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                            <span style="color: #64748b;">Incept Date:</span>
                            <span style="font-weight: 600;">${fund.inception_date || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cost -->
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ecf0f1;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 4px;">
                        <span style="color: #64748b;">Incept %:</span>
                        <span class="${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                        <span style="color: #64748b;">Expense:</span>
                        <span class="${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}" style="font-weight: 600;">${fund.net_expense.toFixed(2)}%</span>
                    </div>
                </div>
            </div>
        `}).join('');

        // YTD Chart
        const ytdCanvas = document.getElementById('ytdChart');
        const existingYtdChart = Chart.getChart(ytdCanvas);
        if (existingYtdChart) existingYtdChart.destroy();
        
        const ytdCtx = ytdCanvas.getContext('2d');
        ytdCanvas.style.height = (funds.length * 25) + 'px';
        ytdCanvas.style.maxHeight = '600px';
        
        new Chart(ytdCtx, {
            type: 'bar',
            data: {
                labels: sortedByYTD.map(f => f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name),
                datasets: [{
                    label: 'YTD Return (%)',
                    data: sortedByYTD.map(f => f.ytd),
                    backgroundColor: sortedByYTD.map(f => 
                        f.ytd > 15 ? 'rgba(231, 76, 60, 0.8)' :
                        f.ytd > 10 ? 'rgba(241, 196, 15, 0.8)' :
                        f.ytd > 5 ? 'rgba(52, 152, 219, 0.8)' :
                        'rgba(149, 165, 166, 0.8)'
                    ),
                    borderColor: sortedByYTD.map(f => 
                        f.ytd > 15 ? 'rgba(231, 76, 60, 1)' :
                        f.ytd > 10 ? 'rgba(241, 196, 15, 1)' :
                        f.ytd > 5 ? 'rgba(52, 152, 219, 1)' :
                        'rgba(149, 165, 166, 1)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const clickedFund = sortedByYTD[index];
                        const fundIndex = funds.findIndex(f => f.name === clickedFund.name);
                        jumpToFundDeepDive(fundIndex);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'YTD: ' + context.parsed.x.toFixed(2) + '%';
                            },
                            footer: () => 'üí° Click to view details'
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Return (%)' }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });

        // Performance Comparison Chart
        const comparisonCanvas = document.getElementById('performanceComparisonChart');
        const existingComparisonChart = Chart.getChart(comparisonCanvas);
        if (existingComparisonChart) existingComparisonChart.destroy();
        
        const comparisonCtx = comparisonCanvas.getContext('2d');
        
        // Category-based colors for scatter plot
        const scatterCategoryColors = {
            'Short Bonds/Stable/MMkt': 'rgba(149, 165, 166, 0.7)',      // Gray
            'Interm./Long-Term Bonds': 'rgba(231, 76, 60, 0.7)',        // Red
            'Large-Cap Stocks': 'rgba(52, 152, 219, 0.7)',              // Blue
            'Small/Mid-Cap Stocks': 'rgba(243, 156, 18, 0.7)',          // Orange
            'International Stocks': 'rgba(39, 174, 96, 0.7)',           // Green
            'Multi-Asset/Other': 'rgba(155, 89, 182, 0.7)'              // Purple
        };
        
        const scatterCategoryBorders = {
            'Short Bonds/Stable/MMkt': 'rgba(149, 165, 166, 1)',
            'Interm./Long-Term Bonds': 'rgba(231, 76, 60, 1)',
            'Large-Cap Stocks': 'rgba(52, 152, 219, 1)',
            'Small/Mid-Cap Stocks': 'rgba(243, 156, 18, 1)',
            'International Stocks': 'rgba(39, 174, 96, 1)',
            'Multi-Asset/Other': 'rgba(155, 89, 182, 1)'
        };
        
        new Chart(comparisonCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Funds',
                    data: funds.filter(f => f["3_year"]).map(f => ({
                        x: f["1_year"],
                        y: f["3_year"],
                        label: f.name,
                        category: f.category
                    })),
                    backgroundColor: funds.filter(f => f["3_year"]).map(f => scatterCategoryColors[f.category] || 'rgba(102, 126, 234, 0.6)'),
                    borderColor: funds.filter(f => f["3_year"]).map(f => scatterCategoryBorders[f.category] || 'rgba(102, 126, 234, 1)'),
                    borderWidth: 2,
                    pointRadius: 9,
                    pointHoverRadius: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const datasetIndex = activeElements[0].datasetIndex;
                        const index = activeElements[0].index;
                        const clickedPoint = funds.filter(f => f["3_year"])[index];
                        const fundIndex = funds.findIndex(f => f.name === clickedPoint.name);
                        jumpToFundDeepDive(fundIndex);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].raw.label || '';
                            },
                            label: function(context) {
                                const point = context.raw;
                                return [
                                    'Category: ' + (point.category || 'Unknown'),
                                    '1 Year: ' + context.parsed.x.toFixed(2) + '%',
                                    '3 Year: ' + context.parsed.y.toFixed(2) + '%'
                                ];
                            },
                            footer: () => 'üí° Click to view details'
                        }
                    }
                },
                scales: {
                    x: {
                        title: { 
                            display: true, 
                            text: '1-Year Return (%)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: { font: { size: 12 } }
                    },
                    y: {
                        title: { 
                            display: true, 
                            text: '3-Year Return (%)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: { font: { size: 12 } }
                    }
                }
            }
        });

        // Expense Chart
        const expenseCanvas = document.getElementById('expenseChart');
        const existingExpenseChart = Chart.getChart(expenseCanvas);
        if (existingExpenseChart) existingExpenseChart.destroy();
        
        const expenseCtx = expenseCanvas.getContext('2d');
        
        const sortedByExpense = [...funds].sort((a, b) => a.net_expense - b.net_expense);
        const expenseChartInstance = new Chart(expenseCtx, {
            type: 'bar',
            data: {
                labels: sortedByExpense.map(f => f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name),
                datasets: [{
                    label: 'Net Expense Ratio (%)',
                    data: sortedByExpense.map(f => f.net_expense),
                    backgroundColor: sortedByExpense.map(f => 
                        f.net_expense < 0.2 ? 'rgba(39, 174, 96, 0.8)' :
                        f.net_expense < 0.5 ? 'rgba(241, 196, 15, 0.8)' :
                        'rgba(231, 76, 60, 0.8)'
                    ),
                    borderColor: sortedByExpense.map(f => 
                        f.net_expense < 0.2 ? 'rgba(39, 174, 96, 1)' :
                        f.net_expense < 0.5 ? 'rgba(241, 196, 15, 1)' :
                        'rgba(231, 76, 60, 1)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const clickedFund = sortedByExpense[index];
                        const fundIndex = funds.findIndex(f => f.name === clickedFund.name);
                        jumpToFundDeepDive(fundIndex);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            footer: () => 'üí° Click to view details'
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Expense Ratio (%)' }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });

        // Category Performance Chart
        const categoryCanvas = document.getElementById('categoryChart');
        const existingCategoryChart = Chart.getChart(categoryCanvas);
        if (existingCategoryChart) existingCategoryChart.destroy();
        const categoryCtx = categoryCanvas.getContext('2d');
        
        // Filter out funds with invalid categories
        const validFunds = funds.filter(f => f && f.category && typeof f.category === 'string');
        
        window.categories = [...new Set(validFunds.map(f => f.category))];  // Update global categories
        categories = window.categories; // Update local reference
        
        const categoryAvgYTD = categories.map(cat => {
            const categoryFunds = validFunds.filter(f => f.category === cat);
            if (!categoryFunds || categoryFunds.length === 0) return 0;
            
            // Calculate average, filtering out invalid YTD values
            const validYTDs = categoryFunds
                .filter(f => f.ytd !== null && f.ytd !== undefined && !isNaN(f.ytd))
                .map(f => f.ytd);
            
            if (validYTDs.length === 0) return 0;
            
            return validYTDs.reduce((sum, ytd) => sum + ytd, 0) / validYTDs.length;
        });
        
        // Define distinct colors for each category - Corporate Blue-Gray Professional
        const categoryColors = [
            'rgba(52, 73, 94, 0.9)',     // Dark slate blue
            'rgba(44, 62, 80, 0.9)',     // Darker slate
            'rgba(52, 152, 219, 0.9)',   // Professional blue
            'rgba(41, 128, 185, 0.9)',   // Medium blue
            'rgba(93, 109, 126, 0.9)',   // Gray blue
            'rgba(69, 85, 96, 0.9)',     // Steel blue
            'rgba(58, 83, 155, 0.9)',    // Navy blue
            'rgba(127, 140, 141, 0.9)'   // Slate gray
        ];
        
        const categoryBorderColors = [
            'rgba(52, 73, 94, 1)',
            'rgba(44, 62, 80, 1)',
            'rgba(52, 152, 219, 1)',
            'rgba(41, 128, 185, 1)',
            'rgba(93, 109, 126, 1)',
            'rgba(69, 85, 96, 1)',
            'rgba(58, 83, 155, 1)',
            'rgba(127, 140, 141, 1)'
        ];
        
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Average YTD Return (%)',
                    data: categoryAvgYTD,
                    backgroundColor: categories.map((cat, idx) => categoryColors[idx % categoryColors.length]),
                    borderColor: categories.map((cat, idx) => categoryBorderColors[idx % categoryBorderColors.length]),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.0,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Avg YTD: ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Average YTD Return (%)',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 10 },
                            maxRotation: 90,
                            minRotation: 90,
                            autoSkip: false,
                            callback: function(value, index, values) {
                                // Wrap long category names
                                const label = this.getLabelForValue(value);
                                if (label.length > 20) {
                                    return label.substring(0, 17) + '...';
                                }
                                return label;
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Multi-Period Category Performance Chart
        const categoryMultiPeriodCanvas = document.getElementById('categoryMultiPeriodChart');
        const existingCategoryMultiChart = Chart.getChart(categoryMultiPeriodCanvas);
        if (existingCategoryMultiChart) existingCategoryMultiChart.destroy();
        const categoryMultiPeriodCtx = categoryMultiPeriodCanvas.getContext('2d');
        
        // Time periods
        const categoryTimePeriods = ['1_month', '3_month', 'ytd', '1_year', '3_year', '5_year'];
        const categoryPeriodLabels = ['1 Month', '3 Month', 'YTD', '1 Year', '3 Year', '5 Year'];
        
        // Calculate average returns for each category across all time periods
        const categoryDatasets = categories.map((cat, idx) => {
            const categoryFunds = funds.filter(f => f.category === cat);
            
            const avgReturns = categoryTimePeriods.map(period => {
                const fundsWithData = categoryFunds.filter(f => f[period] !== null && f[period] !== undefined);
                if (fundsWithData.length === 0) return null;
                const sum = fundsWithData.reduce((acc, f) => acc + f[period], 0);
                return sum / fundsWithData.length;
            });
            
            return {
                label: cat,
                data: avgReturns,
                borderColor: categoryColors[idx % categoryColors.length],
                backgroundColor: categoryColors[idx % categoryColors.length].replace('0.8)', '0.2)'),
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                tension: 0.3,
                fill: false
            };
        });
        
        new Chart(categoryMultiPeriodCtx, {
            type: 'line',
            data: {
                labels: categoryPeriodLabels,
                datasets: categoryDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            font: { size: 11 },
                            padding: 10,
                            boxWidth: 25
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                if (value === null || value === undefined) {
                                    return context.dataset.label + ': N/A';
                                }
                                return context.dataset.label + ': ' + value.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period',
                            font: { size: 13, weight: 'bold' }
                        },
                        ticks: { font: { size: 11 } },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Return (%)',
                            font: { size: 13, weight: 'bold' }
                        },
                        ticks: { font: { size: 11 } },
                        grid: { color: 'rgba(0, 0, 0, 0.08)' }
                    }
                }
            }
        });
        
        // Custom Fund Comparison Tool
        let customCompChart = null;
        let custom10kChart = null;
        
        // Populate fund checkboxes grouped by category
        const fundCheckboxesContainer = document.getElementById('fundCheckboxes');
        
        // Group funds by category - FIX CORRUPTED DATA
        const fundsByCategory = {};
        funds.forEach((fund, idx) => {
            // Validate and fix category
            let category = fund.category;
            
            // If category is missing, numeric, or invalid, use a default
            if (!category || typeof category !== 'string' || category.trim() === '' || !isNaN(category)) {
                console.warn(`Fund "${fund.name}" has invalid category:`, category);
                category = 'Uncategorized';
            }
            
            if (!fundsByCategory[category]) {
                fundsByCategory[category] = [];
            }
            fundsByCategory[category].push({ fund, idx });
        });
        
        // Category colors for fund selection
        const fundSelectionColors = {
            'Short Bonds/Stable/MMkt': '#95a5a6',
            'Interm./Long-Term Bonds': '#dc2626',
            'Large-Cap Stocks': '#3498db',
            'Small/Mid-Cap Stocks': '#ea580c',
            'International Stocks': '#059669',
            'Multi-Asset/Other': '#9b59b6',
            'Uncategorized': '#e67e22'
        };
        
        fundCheckboxesContainer.innerHTML = Object.keys(fundsByCategory).map(category => {
            const categoryFunds = fundsByCategory[category];
            const categoryColor = fundSelectionColors[category] || '#64748b';
            
            return `
                <div style="margin-bottom: 20px;">
                    <div style="background: ${categoryColor}; color: white; padding: 8px 12px; border-radius: 6px 6px 0 0; font-weight: 600; font-size: 0.95em; display: flex; justify-content: space-between; align-items: center;">
                        <span>${category}</span>
                        <span style="font-size: 0.85em; opacity: 0.9;">${categoryFunds.length} funds</span>
                    </div>
                    <div style="background: white; border: 2px solid ${categoryColor}; border-top: none; border-radius: 0 0 6px 6px; padding: 10px;">
                        ${categoryFunds.map(({ fund, idx }) => `
                            <label style="display: flex; align-items: center; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s; margin-bottom: 4px;" 
                                   onmouseover="this.style.background='#f8f9fa'" 
                                   onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="${idx}" style="margin-right: 10px; cursor: pointer; width: 16px; height: 16px;" class="fund-checkbox">
                                <span style="font-size: 0.9em; color: #2c3e50;">${fund.name}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
        
        // Regenerate filter buttons with new categories
        if (typeof regenerateFilterButtons === 'function') {
            regenerateFilterButtons();
        }
        
        // Regenerate Portfolio Optimizer sections
        regeneratePortfolioOptimizer();
        
        // Regenerate Advanced Analytics charts
        regenerateAdvancedAnalytics();
        
        } catch (error) {
            console.error('===== ERROR IN updateStats =====');
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            console.error('window.funds state:', window.funds);
            console.error('================================');
            
            // Show user-friendly message
            alert('Error updating dashboard: ' + error.message + '\n\nPlease check the browser console (F12) for details, or try reloading the page.');
        }
        }  // End of updateStats function
        
        // Helper function to validate chart data
        function validateChartData(data, chartName) {
            if (!Array.isArray(data)) {
                console.error(`${chartName}: data is not an array`, data);
                return false;
            }
            if (data.length === 0) {
                console.warn(`${chartName}: data array is empty`);
                return false;
            }
            return true;
        }
        
        function updateCustomComparison() {
            const checkboxes = document.querySelectorAll('.fund-checkbox:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIndices.length < 2) {
                alert('Please select at least 2 funds to compare');
                return;
            }
            
            if (selectedIndices.length > 10) {
                alert('Please select no more than 10 funds for readability');
                return;
            }
            
            const selectedFunds = selectedIndices.map(idx => window.funds[idx]); // Use current portfolio funds
            
            // Show chart, hide message
            document.getElementById('customCompChartContainer').style.display = 'block';
            document.getElementById('customCompMessage').style.display = 'none';
            
            // Create the comparison chart
            const customCompCanvas = document.getElementById('customCompChart');
            const existingCustomCompChart = Chart.getChart(customCompCanvas);
            if (existingCustomCompChart) existingCustomCompChart.destroy();
            const customCompCtx = customCompCanvas.getContext('2d');
            
            const compTimePeriods = ['1_month', '3_month', 'ytd', '1_year', '3_year', '5_year'];
            const compPeriodLabels = ['1 Month', '3 Month', 'YTD', '1 Year', '3 Year', '5 Year'];
            
            const compColors = [
                'rgba(231, 76, 60, 1)',
                'rgba(52, 152, 219, 1)',
                'rgba(46, 204, 113, 1)',
                'rgba(155, 89, 182, 1)',
                'rgba(241, 196, 15, 1)',
                'rgba(230, 126, 34, 1)',
                'rgba(26, 188, 156, 1)',
                'rgba(52, 73, 94, 1)',
                'rgba(22, 160, 133, 1)',
                'rgba(243, 156, 18, 1)',
            ];
            
            const compDatasets = selectedFunds.map((fund, idx) => {
                const data = compTimePeriods.map(p => fund[p]);
                
                return {
                    label: fund.name.length > 30 ? fund.name.substring(0, 27) + '...' : fund.name,
                    data: data,
                    borderColor: compColors[idx % compColors.length],
                    backgroundColor: compColors[idx % compColors.length].replace('1)', '0.1)'),
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: false
                };
            });
            
            customCompChart = new Chart(customCompCtx, {
                type: 'line',
                data: {
                    labels: compPeriodLabels,
                    datasets: compDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const clickedFund = selectedFunds[datasetIndex];
                            const fundIndex = window.funds.findIndex(f => f.name === clickedFund.name);
                            jumpToFundDeepDive(fundIndex);
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                font: { size: 10 },
                                padding: 8,
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null || value === undefined) {
                                        return context.dataset.label + ': N/A';
                                    }
                                    return context.dataset.label + ': ' + value.toFixed(2) + '%';
                                },
                                footer: () => 'üí° Click to view fund details'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Return (%)',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });
            
            // Create $10,000 Growth Chart
            document.getElementById('custom10kChartContainer').style.display = 'block';
            
            const custom10kCanvas = document.getElementById('custom10kChart');
            const existingCustom10kChart = Chart.getChart(custom10kCanvas);
            if (existingCustom10kChart) existingCustom10kChart.destroy();
            const custom10kCtx = custom10kCanvas.getContext('2d');
            
            // Calculate $10k growth for each time period
            const growthTimePeriods = ['1_month', '3_month', 'ytd', '1_year', '3_year', '5_year'];
            const growthPeriodLabels = ['1 Month', '3 Month', 'YTD', '1 Year', '3 Year', '5 Year'];
            
            const growth10kDatasets = selectedFunds.map((fund, idx) => {
                const growthData = growthTimePeriods.map(period => {
                    const returnPct = fund[period];
                    if (returnPct === null || returnPct === undefined) return null;
                    
                    // For periods less than a year, calculate simple return
                    // For multi-year periods, the return is already annualized, so compound it
                    let years;
                    if (period === '1_month') years = 1/12;
                    else if (period === '3_month') years = 3/12;
                    else if (period === 'ytd') years = 10/12; // October data
                    else if (period === '1_year') years = 1;
                    else if (period === '3_year') years = 3;
                    else if (period === '5_year') years = 5;
                    
                    // Calculate final value
                    const finalValue = 10000 * Math.pow(1 + (returnPct / 100), years);
                    return finalValue;
                });
                
                return {
                    label: fund.name.length > 30 ? fund.name.substring(0, 27) + '...' : fund.name,
                    data: growthData,
                    borderColor: compColors[idx % compColors.length],
                    backgroundColor: compColors[idx % compColors.length].replace('1)', '0.1)'),
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: false
                };
            });
            
            custom10kChart = new Chart(custom10kCtx, {
                type: 'line',
                data: {
                    labels: growthPeriodLabels,
                    datasets: growth10kDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const clickedFund = selectedFunds[datasetIndex];
                            const fundIndex = funds.findIndex(f => f.name === clickedFund.name);
                            jumpToFundDeepDive(fundIndex);
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                font: { size: 10 },
                                padding: 8,
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null || value === undefined) {
                                        return context.dataset.label + ': N/A';
                                    }
                                    const gain = value - 10000;
                                    return [
                                        context.dataset.label,
                                        'Final Value: $' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                                        'Gain: $' + gain.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' (' + ((gain/10000)*100).toFixed(1) + '%)'
                                    ];
                                },
                                footer: () => 'üí° Click to view fund details'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value of $10,000 Investment',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { 
                                font: { size: 11 },
                                callback: function(value) {
                                    return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });
        }
        
        function clearCustomComparison() {
            // Uncheck all checkboxes
            document.querySelectorAll('.fund-checkbox').forEach(cb => cb.checked = false);
            
            // Hide charts, show message
            document.getElementById('customCompChartContainer').style.display = 'none';
            document.getElementById('custom10kChartContainer').style.display = 'none';
            document.getElementById('customCompMessage').style.display = 'block';
            
            // Destroy charts
            if (customCompChart) {
                customCompChart.destroy();
                customCompChart = null;
            }
            if (custom10kChart) {
                custom10kChart.destroy();
                custom10kChart = null;
            }
        }

        // Generate category filter buttons
        function regenerateFilterButtons() {
            const filterButtons = document.getElementById('filterButtons');
            const allCategories = ['All', ...window.categories];
            filterButtons.innerHTML = allCategories.map(cat => 
                `<button class="filter-btn ${cat === 'All' ? 'active' : ''}" data-category="${cat}">${cat}</button>`
            ).join('');
        }
        
        // Initial filter buttons
        regenerateFilterButtons();
        
        // Update GLOBAL sorting variables with current funds
        window.currentFilteredFunds = [...window.funds];
        currentFilteredFunds = window.currentFilteredFunds;

        // GLOBAL Sorting function - accessible everywhere
        function sortTable(column) {
            console.log('sortTable called with column:', column);
            console.log('currentFilteredFunds length:', window.currentFilteredFunds.length);
            
            // Toggle sort direction if clicking same column
            if (window.currentSortColumn === column) {
                window.currentSortDirection = window.currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                window.currentSortColumn = column;
                window.currentSortDirection = 'desc'; // Default to descending for new column
            }
            
            console.log('Sorting by', column, 'in', window.currentSortDirection, 'order');
            
            // Update visual indicators
            document.querySelectorAll('#fundsTable th [id^="sort-"]').forEach(el => {
                el.textContent = '‚áÖ';
            });
            const indicator = document.getElementById(`sort-${column}`);
            if (indicator) {
                indicator.textContent = window.currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
            }
            
            // Sort the current filtered funds
            const sorted = [...window.currentFilteredFunds].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle null/undefined values
                if (aVal === null || aVal === undefined) aVal = -Infinity;
                if (bVal === null || bVal === undefined) bVal = -Infinity;
                
                // String comparison for name and category
                if (column === 'name' || column === 'category') {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                    return window.currentSortDirection === 'asc' 
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }
                
                // Numeric comparison
                return window.currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            console.log('Sorted array length:', sorted.length);
            console.log('First fund after sort:', sorted[0]?.name, sorted[0]?.[column]);
            
            window.renderTable(sorted);
            console.log('Table rendered');
        }
        
        // Make sortTable globally accessible
        window.sortTable = sortTable;

        
        // ==========================================
        // PORTFOLIO OPTIMIZER
        // ==========================================
        
        function regeneratePortfolioOptimizer() {
            const funds = window.funds; // Always use current funds
            const categories = window.categories;
            
        // 1. Top Performers by Category
        const topPerformersByCategory = {};
        const worstPerformersByCategory = {};
        
        categories.forEach(cat => {
            const categoryFunds = funds.filter(f => f.category === cat && f['1_year']);
            
            if (categoryFunds.length > 1) {
                // Multiple funds - show both best and worst
                const topFund = categoryFunds.reduce((best, current) => 
                    current['1_year'] > best['1_year'] ? current : best
                );
                const worstFund = categoryFunds.reduce((worst, current) => 
                    current['1_year'] < worst['1_year'] ? current : worst
                );
                topPerformersByCategory[cat] = topFund;
                worstPerformersByCategory[cat] = worstFund;
            } else if (categoryFunds.length === 1) {
                // Single fund - put in best if performing well (>10%), worst otherwise
                const singleFund = categoryFunds[0];
                if (singleFund['1_year'] >= 10) {
                    topPerformersByCategory[cat] = singleFund;
                } else {
                    worstPerformersByCategory[cat] = singleFund;
                }
            }
        });
        
        const topPerfContainer = document.getElementById('topPerformersByCategory');
        topPerfContainer.innerHTML = Object.entries(topPerformersByCategory).map(([cat, fund]) => {
            const fundIndex = funds.findIndex(f => f.name === fund.name);
            return `
                <div class="fund-card" style="border-left: 4px solid #059669; background: linear-gradient(135deg, #fff 0%, rgba(39, 174, 96, 0.05) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #059669; font-size: 0.85em;">${cat}</div>
                        <div style="background: #059669; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">TOP PICK</div>
                    </div>
                    <h4 style="margin-bottom: 8px; cursor: pointer;" onclick="jumpToFundDeepDive(${fundIndex})">${fund.name}</h4>
                    <div class="performance-row">
                        <span class="metric">1-Year Return:</span>
                        <span class="value positive" style="font-size: 1.3em; font-weight: bold;">${fund['1_year'].toFixed(2)}%</span>
                    </div>
                    ${fund['3_year'] ? `<div class="performance-row">
                        <span class="metric">3-Year Return:</span>
                        <span class="value positive">${fund['3_year'].toFixed(2)}%</span>
                    </div>` : ''}
                    <div class="performance-row">
                        <span class="metric">Inception Return:</span>
                        <span class="value ${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                    <div class="performance-row">
                        <span class="metric">Expense Ratio:</span>
                        <span class="value ${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}">${fund.net_expense.toFixed(2)}%</span>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(39, 174, 96, 0.1); border-radius: 6px; font-size: 0.85em; color: #059669;">
                        <strong>üí° Action:</strong> Consider increasing allocation
                    </div>
                </div>
            `;
        }).join('');
        
        // Worst Performers by Category
        const worstPerfContainer = document.getElementById('worstPerformersByCategory');
        worstPerfContainer.innerHTML = Object.entries(worstPerformersByCategory).map(([cat, fund]) => {
            const fundIndex = funds.findIndex(f => f.name === fund.name);
            return `
                <div class="fund-card" style="border-left: 4px solid #dc2626; background: linear-gradient(135deg, #fff 0%, rgba(231, 76, 60, 0.05) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #dc2626; font-size: 0.85em;">${cat}</div>
                        <div style="background: #dc2626; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">AVOID</div>
                    </div>
                    <h4 style="margin-bottom: 8px; cursor: pointer;" onclick="jumpToFundDeepDive(${fundIndex})">${fund.name}</h4>
                    <div class="performance-row">
                        <span class="metric">1-Year Return:</span>
                        <span class="value negative" style="font-size: 1.3em; font-weight: bold;">${fund['1_year'].toFixed(2)}%</span>
                    </div>
                    ${fund['3_year'] ? `<div class="performance-row">
                        <span class="metric">3-Year Return:</span>
                        <span class="value ${fund['3_year'] >= 0 ? 'positive' : 'negative'}">${fund['3_year'].toFixed(2)}%</span>
                    </div>` : ''}
                    <div class="performance-row">
                        <span class="metric">Inception Return:</span>
                        <span class="value ${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                    <div class="performance-row">
                        <span class="metric">Expense Ratio:</span>
                        <span class="value ${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}">${fund.net_expense.toFixed(2)}%</span>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px; font-size: 0.85em; color: #dc2626;">
                        <strong>‚ö†Ô∏è Action:</strong> Consider reducing or avoiding
                    </div>
                </div>
            `;
        }).join('');
        
        // 2. Rebalancing Recommendations
        const recommendations = [];
        
        // Find high-cost, low-return funds to reduce
        const underperformers = funds.filter(f => f['1_year'] < 10 && f.net_expense > 0.4).slice(0, 3);
        // Find low-cost, high-return funds to increase
        const overperformers = funds.filter(f => f['1_year'] > 15 && f.net_expense < 0.3).slice(0, 3);
        
        underperformers.forEach(under => {
            const fundIndex = funds.findIndex(f => f.name === under.name);
            recommendations.push({
                type: 'reduce',
                fund: under,
                fundIndex: fundIndex,
                reason: `Low return (${under['1_year'].toFixed(1)}%) with high cost (${under.net_expense.toFixed(2)}%)`
            });
        });
        
        overperformers.forEach(over => {
            const fundIndex = funds.findIndex(f => f.name === over.name);
            recommendations.push({
                type: 'increase',
                fund: over,
                fundIndex: fundIndex,
                reason: `Strong return (${over['1_year'].toFixed(1)}%) with low cost (${over.net_expense.toFixed(2)}%)`
            });
        });
        
        const recsContainer = document.getElementById('rebalancingRecs');
        recsContainer.innerHTML = recommendations.map(rec => {
            const isIncrease = rec.type === 'increase';
            const color = isIncrease ? '#059669' : '#dc2626';
            const icon = isIncrease ? 'üìà' : 'üìâ';
            const action = isIncrease ? 'INCREASE ALLOCATION' : 'REDUCE ALLOCATION';
            
            return `
                <div class="fund-card" style="border-left: 4px solid ${color}; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                        <h4 style="margin: 0; cursor: pointer; flex: 1; font-size: 1em;" onclick="jumpToFundDeepDive(${rec.fundIndex})">${rec.fund.name}</h4>
                        <div style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">${action}</div>
                    </div>
                    <div style="color: #64748b; font-size: 0.85em; margin-bottom: 8px;">${icon} ${rec.reason}</div>
                    
                    <!-- Short-term Returns -->
                    <div style="margin-top: 8px;">
                        <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Short-term</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">1 Mo:</span>
                                <span class="${rec.fund['1_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${rec.fund['1_month'].toFixed(2)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">3 Mo:</span>
                                <span class="${rec.fund['3_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${rec.fund['3_month'].toFixed(2)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">YTD:</span>
                                <span class="${rec.fund.ytd >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${rec.fund.ytd.toFixed(2)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">1 Yr:</span>
                                <span class="${rec.fund['1_year'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${rec.fund['1_year'].toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Long-term Returns -->
                    <div style="margin-top: 10px;">
                        <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Long-term</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">3 Yr:</span>
                                <span class="${rec.fund['3_year'] ? (rec.fund['3_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${rec.fund['3_year'] ? rec.fund['3_year'].toFixed(2) + '%' : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">5 Yr:</span>
                                <span class="${rec.fund['5_year'] ? (rec.fund['5_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${rec.fund['5_year'] ? rec.fund['5_year'].toFixed(2) + '%' : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">10 Yr:</span>
                                <span class="${rec.fund['10_year'] ? (rec.fund['10_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${rec.fund['10_year'] ? rec.fund['10_year'].toFixed(2) + '%' : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                <span style="color: #64748b;">Incept %:</span>
                                <span class="${rec.fund.inception ? (rec.fund.inception >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${rec.fund.inception ? rec.fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost -->
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ecf0f1;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                            <span style="color: #64748b;">Expense:</span>
                            <span class="${rec.fund.net_expense < 0.3 ? 'expense-low' : rec.fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}" style="font-weight: 600;">${rec.fund.net_expense.toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        } // End of regeneratePortfolioOptimizer function
        
        // ==========================================
        // ADVANCED ANALYTICS - 6 CHARTS (2x2 Grid)
        // ==========================================
        
        function regenerateAdvancedAnalytics() {
            const funds = window.funds; // Always use current funds
            
        // 1. RISK-ADJUSTED RETURNS (SHARPE RATIO) - Top 12 funds
        const sharpeData = funds.filter(f => f['1_year'] && f['3_month'] && f.ytd).map(f => {
            const returns = [f['1_month'], f['3_month'], f.ytd, f['1_year']].filter(r => r !== null);
            const avgReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? avgReturn / stdDev : 0;
            
            return { fund: f, sharpe: sharpeRatio };
        }).sort((a, b) => b.sharpe - a.sharpe).slice(0, 12);
        
        const sharpeCanvas = document.getElementById('sharpeRatioChart');
        const existingSharpeChart = Chart.getChart(sharpeCanvas);
        if (existingSharpeChart) existingSharpeChart.destroy();
        
        new Chart(sharpeCanvas, {
            type: 'bar',
            data: {
                labels: sharpeData.map(d => d.fund.name.length > 22 ? d.fund.name.substring(0, 19) + '...' : d.fund.name),
                datasets: [{
                    label: 'Sharpe Ratio',
                    data: sharpeData.map(d => d.sharpe),
                    backgroundColor: sharpeData.map(d => d.sharpe > 3 ? 'rgba(39, 174, 96, 0.85)' : d.sharpe > 2 ? 'rgba(52, 152, 219, 0.85)' : 'rgba(241, 196, 15, 0.85)'),
                    borderRadius: 8,
                    barThickness: 25
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const idx = funds.findIndex(f => f.name === sharpeData[activeEls[0].index].fund.name);
                        jumpToFundDeepDive(idx);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 16, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: (context) => `Sharpe Ratio: ${context.parsed.x.toFixed(2)} (Higher = Better)`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Sharpe Ratio', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
        
        // 2. PERFORMANCE MOMENTUM (3-month vs 1-year)
        const momentumData = funds.filter(f => f['3_month'] && f['1_year']).map(f => ({
            x: f['1_year'],
            y: f['3_month'],
            label: f.name,
            color: f['3_month'] > f['1_year'] ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)'
        }));
        
        const momentumCanvas = document.getElementById('momentumChart');
        const existingMomentumChart = Chart.getChart(momentumCanvas);
        if (existingMomentumChart) existingMomentumChart.destroy();
        
        new Chart(momentumCanvas, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'All Funds',
                    data: momentumData,
                    backgroundColor: momentumData.map(d => d.color),
                    borderColor: 'rgba(255, 255, 255, 1)',
                    borderWidth: 2,
                    pointRadius: 9,
                    pointHoverRadius: 13
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const idx = funds.findIndex(f => f.name === momentumData[activeEls[0].index].label);
                        jumpToFundDeepDive(idx);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: (context) => context[0].raw.label,
                            label: (context) => [
                                `1-Year: ${context.parsed.x.toFixed(2)}%`,
                                `3-Month: ${context.parsed.y.toFixed(2)}%`,
                                context.parsed.y > context.parsed.x ? 'üöÄ Accelerating' : '‚ö†Ô∏è Decelerating'
                            ]
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: '1-Year Return (%)', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.08)' }
                    },
                    y: { 
                        title: { display: true, text: '3-Month Return (%)', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.08)' }
                    }
                }
            }
        });
        
        // 3. CATEGORY HEAT MAP
        const heatMapData = categories.map(cat => {
            const catFunds = funds.filter(f => f.category === cat && f['1_year']);
            if (catFunds.length === 0) return null;
            const avgReturn = catFunds.reduce((sum, f) => sum + f['1_year'], 0) / catFunds.length;
            return { category: cat, return: avgReturn };
        }).filter(d => d !== null).sort((a, b) => b.return - a.return);
        
        const heatMapCanvas = document.getElementById('heatMapChart');
        const existingHeatMapChart = Chart.getChart(heatMapCanvas);
        if (existingHeatMapChart) existingHeatMapChart.destroy();
        
        new Chart(heatMapCanvas, {
            type: 'bar',
            data: {
                labels: heatMapData.map(d => d.category),
                datasets: [{
                    label: 'Avg 1-Year Return',
                    data: heatMapData.map(d => d.return),
                    backgroundColor: heatMapData.map(d => {
                        if (d.return > 15) return 'rgba(39, 174, 96, 0.9)';
                        if (d.return > 10) return 'rgba(52, 152, 219, 0.85)';
                        if (d.return > 5) return 'rgba(241, 196, 15, 0.85)';
                        return 'rgba(231, 76, 60, 0.85)';
                    }),
                    borderRadius: 8,
                    barThickness: 35
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: (context) => `Average 1-Year Return: ${context.parsed.x.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Average 1-Year Return (%)', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
        
        // 4. COMPOUND GROWTH ($10K over 5 years) - Top 12 funds
        const growthFunds = funds.filter(f => f['5_year']).sort((a, b) => b['5_year'] - a['5_year']).slice(0, 12);
        const growthData = growthFunds.map(f => {
            const annualRate = f['5_year'] / 100;
            const futureValue = 10000 * Math.pow(1 + annualRate, 5);
            return { fund: f, fv: futureValue };
        });
        
        const growthChartCanvas = document.getElementById('growthChart');
        const existingGrowthChartMain = Chart.getChart(growthChartCanvas);
        if (existingGrowthChartMain) existingGrowthChartMain.destroy();
        
        new Chart(growthChartCanvas, {
            type: 'bar',
            data: {
                labels: growthData.map(d => d.fund.name.length > 22 ? d.fund.name.substring(0, 19) + '...' : d.fund.name),
                datasets: [{
                    label: 'Final Value',
                    data: growthData.map(d => d.fv),
                    backgroundColor: growthData.map(d => {
                        const value = d.fv;
                        if (value >= 18000) return 'rgba(39, 174, 96, 0.85)';      // Dark green - $18K+
                        if (value >= 16000) return 'rgba(46, 204, 113, 0.85)';     // Bright green - $16K-$18K
                        if (value >= 14000) return 'rgba(52, 152, 219, 0.85)';     // Blue - $14K-$16K
                        if (value >= 12000) return 'rgba(241, 196, 15, 0.85)';     // Yellow - $12K-$14K
                        return 'rgba(231, 76, 60, 0.85)';                           // Red - Below $12K
                    }),
                    borderRadius: 8,
                    barThickness: 25
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const idx = funds.findIndex(f => f.name === growthData[activeEls[0].index].fund.name);
                        jumpToFundDeepDive(idx);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: (context) => [
                                `Final Value: $${context.parsed.x.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
                                `Total Gain: $${(context.parsed.x - 10000).toLocaleString('en-US', {maximumFractionDigits: 0})}`,
                                `From $10,000 investment over 5 years`
                            ]
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Value After 5 Years ($)', font: { weight: 'bold', size: 13 } },
                        ticks: { callback: (value) => '$' + (value/1000).toFixed(0) + 'K' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
        
        // 5. PERFORMANCE SPREAD BY CATEGORY
        const spreadData = categories.map(cat => {
            const catFunds = funds.filter(f => f.category === cat && f['1_year']);
            if (catFunds.length === 0) return null;
            const returns = catFunds.map(f => f['1_year']).sort((a, b) => a - b);
            return {
                category: cat,
                min: returns[0],
                max: returns[returns.length - 1],
                avg: returns.reduce((sum, r) => sum + r, 0) / returns.length
            };
        }).filter(d => d !== null);
        
        const spreadCanvas = document.getElementById('spreadChart');
        const existingSpreadChart = Chart.getChart(spreadCanvas);
        if (existingSpreadChart) existingSpreadChart.destroy();
        
        new Chart(spreadCanvas, {
            type: 'bar',
            data: {
                labels: spreadData.map(d => d.category),
                datasets: [
                    {
                        label: 'Best',
                        data: spreadData.map(d => d.max),
                        backgroundColor: 'rgba(46, 204, 113, 0.9)',
                        borderRadius: 8,
                        barThickness: 22
                    },
                    {
                        label: 'Average',
                        data: spreadData.map(d => d.avg),
                        backgroundColor: 'rgba(52, 152, 219, 0.9)',
                        borderRadius: 8,
                        barThickness: 22
                    },
                    {
                        label: 'Worst',
                        data: spreadData.map(d => d.min),
                        backgroundColor: 'rgba(231, 76, 60, 0.9)',
                        borderRadius: 8,
                        barThickness: 22
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: { font: { size: 13, weight: '600' }, padding: 15 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        callbacks: {
                            label: (context) => `${context.dataset.label} Fund: ${context.parsed.x.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: '1-Year Return (%)', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
        
        // 6. MULTI-PERIOD CONSISTENCY - Top 12
        const rollingData = funds.filter(f => f['1_month'] && f['3_month'] && f.ytd && f['1_year'] && f['3_year']).map(f => {
            const periods = [f['1_month'], f['3_month'], f.ytd, f['1_year'], f['3_year']];
            const avgReturn = periods.reduce((sum, p) => sum + p, 0) / periods.length;
            return { fund: f, avgReturn: avgReturn };
        }).sort((a, b) => b.avgReturn - a.avgReturn).slice(0, 12);
        
        const rollingCanvas = document.getElementById('rollingReturnsChart');
        const existingRollingChart = Chart.getChart(rollingCanvas);
        if (existingRollingChart) existingRollingChart.destroy();
        
        new Chart(rollingCanvas, {
            type: 'bar',
            data: {
                labels: rollingData.map(d => d.fund.name.length > 22 ? d.fund.name.substring(0, 19) + '...' : d.fund.name),
                datasets: [{
                    label: 'Avg Return',
                    data: rollingData.map(d => d.avgReturn),
                    backgroundColor: rollingData.map(d => {
                        if (d.avgReturn > 18) return 'rgba(39, 174, 96, 0.9)';
                        if (d.avgReturn > 15) return 'rgba(46, 204, 113, 0.85)';
                        if (d.avgReturn > 12) return 'rgba(52, 152, 219, 0.85)';
                        if (d.avgReturn > 10) return 'rgba(155, 89, 182, 0.85)';
                        return 'rgba(241, 196, 15, 0.85)';
                    }),
                    borderRadius: 8,
                    barThickness: 25
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const idx = funds.findIndex(f => f.name === rollingData[activeEls[0].index].fund.name);
                        jumpToFundDeepDive(idx);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 14 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: (context) => [
                                `Average Return: ${context.parsed.x.toFixed(2)}%`,
                                `Across all time periods`,
                                `(1mo, 3mo, YTD, 1yr, 3yr)`
                            ]
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Average Return (%)', font: { weight: 'bold', size: 13 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
        
        // 4. Consistency Rankings
        const consistencyScores = funds.map(fund => {
            // Calculate consistency score based on multiple time periods
            const periods = [fund['1_month'], fund['3_month'], fund.ytd, fund['1_year'], fund['3_year'], fund['5_year']];
            const validPeriods = periods.filter(p => p !== null && p !== undefined);
            
            if (validPeriods.length < 3) return null;
            
            const avgReturn = validPeriods.reduce((sum, val) => sum + val, 0) / validPeriods.length;
            const variance = validPeriods.reduce((sum, val) => sum + Math.pow(val - avgReturn, 2), 0) / validPeriods.length;
            const stdDev = Math.sqrt(variance);
            
            // Higher score = more consistent + better returns - lower costs
            const consistencyScore = (avgReturn / (stdDev + 1)) - (fund.net_expense * 10);
            
            return {
                fund: fund,
                score: consistencyScore,
                avgReturn: avgReturn,
                stdDev: stdDev
            };
        }).filter(item => item !== null).sort((a, b) => b.score - a.score);
        
        // Store for sorting
        let currentConsistencyData = [...consistencyScores];
        let consistencySortColumn = 'score';
        let consistencySortDirection = 'desc';
        
        // Function to render consistency table
        function renderConsistencyTable(data) {
            const consistencyTableBody = document.getElementById('consistencyTableBody');
            consistencyTableBody.innerHTML = data.slice(0, 10).map((item, index) => {
                const fundIndex = funds.findIndex(f => f.name === item.fund.name);
                let recommendation = '';
                let recColor = '';
                
                // Recommendation based on original rank (score-based)
                const originalRank = consistencyScores.findIndex(s => s.fund.name === item.fund.name);
                if (originalRank < 3) {
                    recommendation = 'Strong Buy';
                    recColor = '#059669';
                } else if (originalRank < 7) {
                    recommendation = 'Consider';
                    recColor = '#ea580c';
                } else {
                    recommendation = 'Monitor';
                    recColor = '#95a5a6';
                }
                
                return `
                    <tr>
                        <td style="text-align: center; font-weight: bold; font-size: 1.1em;">${index + 1}</td>
                        <td><strong><a class="fund-link" onclick="jumpToFundDeepDive(${fundIndex})">${item.fund.name}</a></strong></td>
                        <td style="text-align: center; font-weight: bold; color: #34495e;">${item.score.toFixed(2)}</td>
                        <td class="positive" style="text-align: center;">${item.avgReturn.toFixed(2)}%</td>
                        <td style="text-align: center;">${item.fund.net_expense.toFixed(2)}%</td>
                        <td style="text-align: center;"><span style="background: ${recColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${recommendation}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Sort consistency table
        function sortConsistencyTable(column) {
            // Toggle direction if same column
            if (consistencySortColumn === column) {
                consistencySortDirection = consistencySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                consistencySortColumn = column;
                consistencySortDirection = 'desc';
            }
            
            const sorted = [...currentConsistencyData].sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'rank':
                        aVal = consistencyScores.findIndex(s => s.fund.name === a.fund.name);
                        bVal = consistencyScores.findIndex(s => s.fund.name === b.fund.name);
                        break;
                    case 'name':
                        aVal = a.fund.name.toLowerCase();
                        bVal = b.fund.name.toLowerCase();
                        return consistencySortDirection === 'asc' 
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    case 'score':
                        aVal = a.score;
                        bVal = b.score;
                        break;
                    case 'avgReturn':
                        aVal = a.avgReturn;
                        bVal = b.avgReturn;
                        break;
                    case 'expense':
                        aVal = a.fund.net_expense;
                        bVal = a.fund.net_expense;
                        break;
                    default:
                        aVal = a.score;
                        bVal = b.score;
                }
                
                return consistencySortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            renderConsistencyTable(sorted);
        }
        
        // Initial render
        renderConsistencyTable(consistencyScores);
        
        // Table rendering
        function renderTable(filteredFunds) {
            window.currentFilteredFunds = filteredFunds;
            const tbody = document.getElementById('fundsTableBody');
            tbody.innerHTML = filteredFunds.map(fund => {
                const fundIndex = funds.findIndex(f => f.name === fund.name);
                return `
                <tr>
                    <td><strong><a class="fund-link" onclick="jumpToFundDeepDive(${fundIndex})">${fund.name}</a></strong></td>
                    <td>${fund.category}</td>
                    <td class="${fund['1_month'] >= 0 ? 'positive' : 'negative'}">${fund['1_month'].toFixed(2)}%</td>
                    <td class="${fund['3_month'] >= 0 ? 'positive' : 'negative'}">${fund['3_month'].toFixed(2)}%</td>
                    <td class="${fund.ytd >= 0 ? 'positive' : 'negative'}"><strong>${fund.ytd.toFixed(2)}%</strong></td>
                    <td class="${fund['1_year'] >= 0 ? 'positive' : 'negative'}">${fund['1_year'].toFixed(2)}%</td>
                    <td class="${fund['3_year'] ? 'positive' : ''}">${fund['3_year'] ? fund['3_year'].toFixed(2) + '%' : 'N/A'}</td>
                    <td class="${fund['5_year'] ? 'positive' : ''}">${fund['5_year'] ? fund['5_year'].toFixed(2) + '%' : 'N/A'}</td>
                    <td class="${fund['10_year'] ? 'positive' : ''}">${fund['10_year'] ? fund['10_year'].toFixed(2) + '%' : 'N/A'}</td>
                    <td class="${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</td>
                    <td class="${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}">${fund.net_expense.toFixed(2)}%</td>
                </tr>
            `}).join('');
        }
        
        // Make renderTable globally accessible
        window.renderTable = renderTable;

        renderTable(window.funds); // Initial render with current funds

        // Filter functionality
        function setupFilterHandlers() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const category = this.dataset.category;
                    const filtered = category === 'All' ? window.funds : window.funds.filter(f => f.category === category);
                    window.currentFilteredFunds = filtered;
                    renderTable(filtered);
                });
            });
        }
        
        // Initial setup
        setupFilterHandlers();

        // Set generated date
        document.getElementById('generatedDate').textContent = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        
        // Fund Search Function
        function searchFunds() {
            const searchTerm = document.getElementById('fundSearchInput').value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.innerHTML = '<p style="color: #64748b; text-align: center;">Type at least 2 characters to search...</p>';
                return;
            }
            
            const matchingFunds = window.funds.filter(f => f.name.toLowerCase().includes(searchTerm));
            
            if (matchingFunds.length === 0) {
                searchResults.innerHTML = '<p style="color: #dc2626; text-align: center;">No funds found matching "' + searchTerm + '"</p>';
                return;
            }
            
            searchResults.innerHTML = matchingFunds.map(fund => {
                const fundIndex = window.funds.findIndex(f => f.name === fund.name);
                return `
                    <div class="fund-card" style="cursor: pointer; padding: 12px;" onclick="jumpToFundDeepDive(${fundIndex})">
                        <h4 style="margin: 0 0 6px 0; color: #2c3e50; font-size: 1em;">${fund.name}</h4>
                        ${fund.ticker ? `<div style="font-family: monospace; font-weight: bold; color: #2980b9; margin-bottom: 6px; font-size: 0.9em;">${fund.ticker}</div>` : ''}
                        <div style="color: #64748b; font-size: 0.85em; margin-bottom: 8px;">${fund.category}</div>
                        
                        <!-- Short-term Returns -->
                        <div style="margin-top: 8px;">
                            <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Short-term</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">1 Mo:</span>
                                    <span class="${fund['1_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['1_month'].toFixed(2)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">3 Mo:</span>
                                    <span class="${fund['3_month'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['3_month'].toFixed(2)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">YTD:</span>
                                    <span class="${fund.ytd >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund.ytd.toFixed(2)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">1 Yr:</span>
                                    <span class="${fund['1_year'] >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${fund['1_year'].toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Long-term Returns -->
                        <div style="margin-top: 10px;">
                            <div style="font-size: 0.75em; font-weight: 600; color: #34495e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Long-term</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.9em;">
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">3 Yr:</span>
                                    <span class="${fund['3_year'] ? (fund['3_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund['3_year'] ? fund['3_year'].toFixed(2) + '%' : 'N/A'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">5 Yr:</span>
                                    <span class="${fund['5_year'] ? (fund['5_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund['5_year'] ? fund['5_year'].toFixed(2) + '%' : 'N/A'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">10 Yr:</span>
                                    <span class="${fund['10_year'] ? (fund['10_year'] >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund['10_year'] ? fund['10_year'].toFixed(2) + '%' : 'N/A'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                    <span style="color: #64748b;">Incept %:</span>
                                    <span class="${fund.inception ? (fund.inception >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">${fund.inception ? fund.inception.toFixed(2) + '%' : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cost -->
                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ecf0f1;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                                <span style="color: #64748b;">Expense:</span>
                                <span class="${fund.net_expense < 0.2 ? 'expense-low' : fund.net_expense < 0.5 ? 'expense-medium' : 'expense-high'}" style="font-weight: 600;">${fund.net_expense.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        window.searchFunds = searchFunds;
        
        // Navigation Functions
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        window.scrollToTop = scrollToTop;
        
        function scrollToTOC() {
            document.getElementById('tocSection').scrollIntoView({ behavior: 'smooth' });
        }
        window.scrollToTOC = scrollToTOC;
        
        function scrollToSearch() {
            document.getElementById('searchSection').scrollIntoView({ behavior: 'smooth' });
        }
        window.scrollToSearch = scrollToSearch;
        
        // Toggle section visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const button = event.target;
            
            // Check if this is a section-content element or a regular div
            if (section.classList.contains('section-content')) {
                // Use the hidden class for section-content elements
                if (section.classList.contains('hidden')) {
                    section.classList.remove('hidden');
                    button.textContent = 'Hide';
                } else {
                    section.classList.add('hidden');
                    button.textContent = 'Show';
                }
            } else {
                // Use inline display style for other elements (like chart containers)
                if (section.style.display === 'none') {
                    section.style.display = '';
                    button.textContent = 'Hide';
                } else {
                    section.style.display = 'none';
                    button.textContent = 'Show';
                }
            }
        }
        window.toggleSection = toggleSection;
        
        } // End of regenerateAdvancedAnalytics function
        
        // Fund Deep Dive functionality
        const fundSelect = document.getElementById('fundSelect');
        const fundDetails = document.getElementById('fundDetails');
        let fundTimelineChart = null;
        let fundGrowthChart = null;
        let fundHoldingsChart = null;
        let fundSectorChart = null;
        let fundConsistencyChart = null;
        let costPerformanceChart = null;
        let riskReturnChart = null;
        let categoryComparisonChart = null;
        
        // Function to jump to fund deep dive
        function jumpToFundDeepDive(fundIndex) {
            // Scroll to fund deep dive section
            document.getElementById('fundDiveContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Show section if hidden
            const section = document.getElementById('fundDiveContent');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                // Find and update the button text
                const buttons = document.querySelectorAll('.toggle-btn');
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes('fundDiveContent')) {
                        btn.textContent = 'Hide';
                    }
                });
            }
            
            // Set the dropdown and trigger change
            fundSelect.value = fundIndex;
            fundSelect.dispatchEvent(new Event('change'));
        }
        
        // Make function globally accessible
        window.jumpToFundDeepDive = jumpToFundDeepDive;
        
        // Populate fund selector
        function populateFundSelector() {
            const fundSelect = document.getElementById('fundSelect');
            if (!fundSelect) {
                console.error('fundSelect element not found');
                return;
            }
            
            // Clear existing options except the first "Choose a fund" option
            while (fundSelect.options.length > 1) {
                fundSelect.remove(1);
            }
            
            // Safety check
            if (!window.funds || !Array.isArray(window.funds) || window.funds.length === 0) {
                console.log('No funds available for selector');
                return;
            }
            
            // Add all funds from current portfolio
            window.funds.forEach((fund, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = fund.name;
                fundSelect.appendChild(option);
            });
        }
        
        // Initial population
        populateFundSelector();
        
        // Expanded sample holdings data
        const sampleHoldings = {
            "Vanguard Total Stock Mkt Idx Adm": [
                { name: "Apple Inc", weight: 7.2 },
                { name: "Microsoft Corp", weight: 6.8 },
                { name: "NVIDIA Corp", weight: 4.5 },
                { name: "Amazon.com Inc", weight: 3.9 },
                { name: "Alphabet Inc Class A", weight: 2.1 },
                { name: "Meta Platforms Inc", weight: 2.0 },
                { name: "Berkshire Hathaway", weight: 1.8 },
                { name: "Eli Lilly and Co", weight: 1.5 },
                { name: "Broadcom Inc", weight: 1.4 },
                { name: "Tesla Inc", weight: 1.3 }
            ],
            "Federated Hermes MDT Large Cap Growth IS": [
                { name: "Microsoft Corp", weight: 8.5 },
                { name: "NVIDIA Corp", weight: 7.2 },
                { name: "Amazon.com Inc", weight: 6.8 },
                { name: "Apple Inc", weight: 6.5 },
                { name: "Meta Platforms Inc", weight: 5.2 },
                { name: "Alphabet Inc", weight: 4.8 },
                { name: "Tesla Inc", weight: 3.9 },
                { name: "Salesforce Inc", weight: 2.8 },
                { name: "Adobe Inc", weight: 2.5 },
                { name: "Netflix Inc", weight: 2.3 }
            ],
            "Vanguard Equity-Income Adm": [
                { name: "JPMorgan Chase", weight: 4.2 },
                { name: "ExxonMobil Corp", weight: 3.8 },
                { name: "Johnson & Johnson", weight: 3.5 },
                { name: "Procter & Gamble", weight: 3.2 },
                { name: "Bank of America", weight: 2.9 },
                { name: "Chevron Corp", weight: 2.7 },
                { name: "Merck & Co", weight: 2.5 },
                { name: "Coca-Cola Co", weight: 2.3 },
                { name: "PepsiCo Inc", weight: 2.1 },
                { name: "AbbVie Inc", weight: 2.0 }
            ]
        };
        
        // Sample sector allocations
        const sampleSectors = {
            "Vanguard Total Stock Mkt Idx Adm": {
                "Technology": 29.5,
                "Financial Services": 13.2,
                "Healthcare": 12.8,
                "Consumer Cyclical": 10.5,
                "Industrials": 8.9,
                "Consumer Defensive": 6.2,
                "Energy": 4.8,
                "Real Estate": 3.5,
                "Utilities": 2.8,
                "Other": 7.8
            },
            "Federated Hermes MDT Large Cap Growth IS": {
                "Technology": 45.5,
                "Consumer Cyclical": 18.2,
                "Communication Services": 12.8,
                "Healthcare": 8.5,
                "Financial Services": 7.2,
                "Industrials": 4.3,
                "Other": 3.5
            },
            "Vanguard Equity-Income Adm": {
                "Financial Services": 22.5,
                "Healthcare": 16.8,
                "Consumer Defensive": 14.2,
                "Energy": 11.5,
                "Industrials": 10.3,
                "Technology": 9.8,
                "Utilities": 7.2,
                "Consumer Cyclical": 4.5,
                "Other": 3.2
            }
        };
        
        fundSelect.addEventListener('change', function() {
            if (this.value === '') {
                fundDetails.style.display = 'none';
                return;
            }
            
            // Safety check
            if (!window.funds || !Array.isArray(window.funds)) {
                console.error('window.funds is not available');
                fundDetails.style.display = 'none';
                alert('Error: Fund data not loaded');
                return;
            }
            
            const fund = window.funds[this.value]; // Use window.funds to get current portfolio data
            
            if (!fund) {
                console.error('Fund not found at index', this.value);
                fundDetails.style.display = 'none';
                return;
            }
            
            fundDetails.style.display = 'block';
            
            // Update fund overview
            const tickerEl = document.getElementById('detailTicker');
            if (fund.ticker) {
                tickerEl.textContent = fund.ticker;
                tickerEl.style.color = '#2980b9';
            } else {
                tickerEl.textContent = 'N/A';
                tickerEl.style.color = '#95a5a6';
            }
            
            document.getElementById('detailInception').textContent = fund.inception_date;
            document.getElementById('detailCategory').textContent = fund.category;
            document.getElementById('detailUnitValue').textContent = '$' + fund.unit_value.toFixed(2);
            document.getElementById('detailExpense').textContent = fund.net_expense.toFixed(2) + '%';
            
            // Add external research links
            const linksContainer = document.getElementById('externalLinks');
            if (fund.ticker) {
                linksContainer.innerHTML = `
                    <div style="padding: 15px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                        <div style="font-size: 0.95em; color: #2c3e50; margin-bottom: 12px; font-weight: 600;">
                            üîó Real-Time External Research
                            <span style="font-size: 0.8em; color: #95a5a6; font-weight: 400; margin-left: 10px;">(Live market data - Dashboard snapshot: October 2024)</span>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <a href="https://finance.yahoo.com/quote/${fund.ticker}" target="_blank" 
                               style="background: #2980b9; color: white; padding: 6px 14px; border-radius: 5px; text-decoration: none; font-size: 0.85em; font-weight: 600; display: inline-block;">
                                üìä Yahoo Finance
                            </a>
                            <a href="https://www.morningstar.com/funds/xnas/${fund.ticker.toLowerCase()}/quote" target="_blank" 
                               style="background: #059669; color: white; padding: 6px 14px; border-radius: 5px; text-decoration: none; font-size: 0.85em; font-weight: 600; display: inline-block;">
                                ‚≠ê Morningstar
                            </a>
                            <a href="https://www.marketwatch.com/investing/fund/${fund.ticker.toLowerCase()}" target="_blank" 
                               style="background: #16a085; color: white; padding: 6px 14px; border-radius: 5px; text-decoration: none; font-size: 0.85em; font-weight: 600; display: inline-block;">
                                üì∞ MarketWatch
                            </a>
                            <a href="https://www.google.com/finance/quote/${fund.ticker}:MUTF" target="_blank" 
                               style="background: #34495e; color: white; padding: 6px 14px; border-radius: 5px; text-decoration: none; font-size: 0.85em; font-weight: 600; display: inline-block;">
                                üîç Google Finance
                            </a>
                            <button onclick="navigator.clipboard.writeText('${fund.ticker}'); this.textContent='‚úì Copied!'; setTimeout(() => this.textContent='üìã Copy', 1500);" 
                                    style="background: #95a5a6; color: white; padding: 6px 14px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.85em; font-weight: 600;">
                                üìã Copy
                            </button>
                        </div>
                    </div>
                `;
            } else {
                linksContainer.innerHTML = '';
            }
            
            // Update performance metrics
            const formatPerf = (val, isPercent = true) => {
                if (val === null) return 'N/A';
                const formatted = isPercent ? val.toFixed(2) + '%' : val;
                return val >= 0 ? '+' + formatted : formatted;
            };
            
            document.getElementById('detail1Mo').textContent = formatPerf(fund['1_month']);
            document.getElementById('detail1Mo').className = 'value ' + (fund['1_month'] >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detail3Mo').textContent = formatPerf(fund['3_month']);
            document.getElementById('detail3Mo').className = 'value ' + (fund['3_month'] >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detailYTD').textContent = formatPerf(fund.ytd);
            document.getElementById('detailYTD').className = 'value ' + (fund.ytd >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detail1Yr').textContent = formatPerf(fund['1_year']);
            document.getElementById('detail1Yr').className = 'value ' + (fund['1_year'] >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detail3Yr').textContent = fund['3_year'] ? formatPerf(fund['3_year']) : 'N/A';
            if (fund['3_year']) {
                document.getElementById('detail3Yr').className = 'value ' + (fund['3_year'] >= 0 ? 'positive' : 'negative');
            }
            
            document.getElementById('detail5Yr').textContent = fund['5_year'] ? formatPerf(fund['5_year']) : 'N/A';
            if (fund['5_year']) {
                document.getElementById('detail5Yr').className = 'value ' + (fund['5_year'] >= 0 ? 'positive' : 'negative');
            }
            
            // Performance Timeline Chart
            if (fundTimelineChart) fundTimelineChart.destroy();
            const timelineCanvas = document.getElementById('fundTimelineChart');
            const existingTimelineChart = Chart.getChart(timelineCanvas);
            if (existingTimelineChart) existingTimelineChart.destroy();
            const timelineCtx = timelineCanvas.getContext('2d');
            fundTimelineChart = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: ['1 Mo', '3 Mo', 'YTD', '1 Yr', '3 Yr', '5 Yr'],
                    datasets: [{
                        label: 'Return (%)',
                        data: [
                            fund['1_month'],
                            fund['3_month'],
                            fund.ytd,
                            fund['1_year'],
                            fund['3_year'] || 0,
                            fund['5_year'] || 0
                        ],
                        backgroundColor: [
                            fund['1_month'] >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                            fund['3_month'] >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                            fund.ytd >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                            fund['1_year'] >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                            (fund['3_year'] || 0) >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                            (fund['5_year'] || 0) >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Return (%)' }
                        }
                    }
                }
            });
            
            // Growth of $10,000 Chart (Line Chart)
            if (fundGrowthChart) fundGrowthChart.destroy();
            const growthCanvas = document.getElementById('fundGrowthChart');
            const existingGrowthChart = Chart.getChart(growthCanvas);
            if (existingGrowthChart) existingGrowthChart.destroy();
            const growthCtx = growthCanvas.getContext('2d');
            
            // Calculate growth values
            const periods = ['Start', '1 Mo', '3 Mo', '6 Mo', 'YTD', '1 Yr', '3 Yr', '5 Yr'];
            const growthValues = [
                10000,
                10000 * (1 + fund['1_month'] / 100),
                10000 * (1 + fund['3_month'] / 100),
                10000 * (1 + (fund['3_month'] * 2) / 100), // Approximate
                10000 * (1 + fund.ytd / 100),
                10000 * (1 + fund['1_year'] / 100),
                fund['3_year'] ? 10000 * Math.pow(1 + fund['3_year'] / 100, 3) : null,
                fund['5_year'] ? 10000 * Math.pow(1 + fund['5_year'] / 100, 5) : null
            ].filter(v => v !== null);
            
            const validPeriods = periods.slice(0, growthValues.length);
            
            fundGrowthChart = new Chart(growthCtx, {
                type: 'line',
                data: {
                    labels: validPeriods,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: growthValues,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Portfolio Value ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Show/hide holdings based on fund type
            const holdingsContainer = document.getElementById('holdingsContainer');
            const sectorContainer = document.getElementById('sectorContainer');
            
            if (sampleHoldings[fund.name]) {
                holdingsContainer.style.display = 'block';
                document.getElementById('fundHoldingsChart').style.display = 'block';
                document.getElementById('noHoldingsMessage')?.remove();
                
                if (fundHoldingsChart) fundHoldingsChart.destroy();
                const holdingsCanvas = document.getElementById('fundHoldingsChart');
                const existingHoldingsChart = Chart.getChart(holdingsCanvas);
                if (existingHoldingsChart) existingHoldingsChart.destroy();
                const holdingsCtx = holdingsCanvas.getContext('2d');
                const holdings = sampleHoldings[fund.name];
                
                fundHoldingsChart = new Chart(holdingsCtx, {
                    type: 'bar',
                    data: {
                        labels: holdings.map(h => h.name),
                        datasets: [{
                            label: 'Weight (%)',
                            data: holdings.map(h => h.weight),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Weight (%)' }
                            }
                        }
                    }
                });
            } else {
                holdingsContainer.style.display = 'block';
                document.getElementById('fundHoldingsChart').style.display = 'none';
                
                // Remove any existing no-data message
                const existingMsg = document.getElementById('noHoldingsMessage');
                if (existingMsg) existingMsg.remove();
                
                const noDataMsg = document.createElement('div');
                noDataMsg.id = 'noHoldingsMessage';
                noDataMsg.style.cssText = 'padding: 30px; text-align: center; color: #64748b; background: #f8f9fa; border-radius: 10px; margin: 10px 0;';
                noDataMsg.innerHTML = '<p style="font-size: 1.1em; margin-bottom: 10px;">üìä Holdings data not available for this fund</p><p style="font-size: 0.9em;">Top holdings information is only available for select funds.</p>';
                holdingsContainer.appendChild(noDataMsg);
            }
            
            // Sector Allocation Chart
            if (sampleSectors[fund.name]) {
                sectorContainer.style.display = 'block';
                
                if (fundSectorChart) fundSectorChart.destroy();
                const sectorCanvas = document.getElementById('fundSectorChart');
                const existingSectorChart = Chart.getChart(sectorCanvas);
                if (existingSectorChart) existingSectorChart.destroy();
                const sectorCtx = sectorCanvas.getContext('2d');
                const sectors = sampleSectors[fund.name];
                
                fundSectorChart = new Chart(sectorCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(sectors),
                        datasets: [{
                            data: Object.values(sectors),
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(39, 174, 96, 0.8)',
                                'rgba(142, 68, 173, 0.8)',
                                'rgba(230, 126, 34, 0.8)',
                                'rgba(149, 165, 166, 0.8)',
                                'rgba(26, 188, 156, 0.8)',
                                'rgba(189, 195, 199, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: { size: 10 },
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                sectorContainer.style.display = 'none';
            }
            
            // Performance Consistency Chart
            if (fundConsistencyChart) fundConsistencyChart.destroy();
            const consistencyCanvas = document.getElementById('fundConsistencyChart');
            const existingConsistencyChart = Chart.getChart(consistencyCanvas);
            if (existingConsistencyChart) existingConsistencyChart.destroy();
            const consistencyCtx = consistencyCanvas.getContext('2d');
            
            // Get category funds for comparison
            const categoryFunds = funds.filter(f => f.category === fund.category);
            
            const consistencyData = {
                labels: ['1 Month', '3 Month', 'YTD', '1 Year', '3 Year', '5 Year'],
                datasets: [
                    {
                        label: fund.name,
                        data: [
                            fund['1_month'],
                            fund['3_month'],
                            fund.ytd,
                            fund['1_year'],
                            fund['3_year'] || 0,
                            fund['5_year'] || 0
                        ],
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Category Average',
                        data: [
                            categoryFunds.reduce((sum, f) => sum + f['1_month'], 0) / categoryFunds.length,
                            categoryFunds.reduce((sum, f) => sum + f['3_month'], 0) / categoryFunds.length,
                            categoryFunds.reduce((sum, f) => sum + f.ytd, 0) / categoryFunds.length,
                            categoryFunds.reduce((sum, f) => sum + f['1_year'], 0) / categoryFunds.length,
                            categoryFunds.filter(f => f['3_year']).reduce((sum, f) => sum + f['3_year'], 0) / categoryFunds.filter(f => f['3_year']).length || 0,
                            categoryFunds.filter(f => f['5_year']).reduce((sum, f) => sum + f['5_year'], 0) / categoryFunds.filter(f => f['5_year']).length || 0
                        ],
                        borderColor: 'rgba(149, 165, 166, 1)',
                        backgroundColor: 'rgba(149, 165, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    }
                ]
            };
            
            fundConsistencyChart = new Chart(consistencyCtx, {
                type: 'line',
                data: consistencyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Return (%)' }
                        }
                    }
                }
            });
            
            // Cost vs Performance Chart
            if (costPerformanceChart) costPerformanceChart.destroy();
            const costPerfCanvas = document.getElementById('costPerformanceChart');
            const existingCostPerfChart = Chart.getChart(costPerfCanvas);
            if (existingCostPerfChart) existingCostPerfChart.destroy();
            const costPerfCtx = costPerfCanvas.getContext('2d');
            
            const categoryWithExpense = categoryFunds.filter(f => f['1_year']);
            
            // Store full names for tooltip
            const fullNames = categoryWithExpense.map(f => f.name);
            
            costPerformanceChart = new Chart(costPerfCtx, {
                type: 'bar',
                data: {
                    labels: categoryWithExpense.map(f => {
                        // For Target Retirement funds, show the year
                        if (f.name.includes('Target Retirement')) {
                            const match = f.name.match(/(\d{4})/);
                            return match ? `TR ${match[1]}` : f.name.substring(0, 20);
                        }
                        // For other funds, show first 20 chars
                        return f.name.length > 20 ? f.name.substring(0, 17) + '...' : f.name;
                    }),
                    datasets: [
                        {
                            label: '1-Year Return (%)',
                            data: categoryWithExpense.map(f => f['1_year']),
                            backgroundColor: categoryWithExpense.map(f => 
                                f.name === fund.name ? 'rgba(231, 76, 60, 0.9)' : 'rgba(52, 152, 219, 0.9)'
                            ),
                            borderColor: categoryWithExpense.map(f => 
                                f.name === fund.name ? 'rgba(231, 76, 60, 1)' : 'rgba(52, 152, 219, 1)'
                            ),
                            borderWidth: 2,
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Expense Ratio (%)',
                            data: categoryWithExpense.map(f => f.net_expense),
                            backgroundColor: categoryWithExpense.map(f => 
                                f.name === fund.name ? 'rgba(241, 196, 15, 0.9)' : 'rgba(100, 116, 139, 0.9)'
                            ),
                            borderColor: categoryWithExpense.map(f => 
                                f.name === fund.name ? 'rgba(241, 196, 15, 1)' : 'rgba(100, 116, 139, 1)'
                            ),
                            borderWidth: 2,
                            borderRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: { font: { size: 12 } }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 15,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    // Show full fund name from stored array
                                    return fullNames[context[0].dataIndex];
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { 
                                display: true, 
                                text: '1-Year Return (%)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { 
                                display: true, 
                                text: 'Expense Ratio (%)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Risk vs Return Chart (Scatter)
            if (riskReturnChart) riskReturnChart.destroy();
            const riskReturnCanvas = document.getElementById('riskReturnChart');
            const existingRiskReturnChart = Chart.getChart(riskReturnCanvas);
            if (existingRiskReturnChart) existingRiskReturnChart.destroy();
            const riskReturnCtx = riskReturnCanvas.getContext('2d');
            
            const categoryFundsWithData = categoryFunds.filter(f => f['3_year'] && f['3_year'] !== null);
            
            if (categoryFundsWithData.length > 0) {
                riskReturnChart = new Chart(riskReturnCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Category Funds',
                            data: categoryFundsWithData.map(f => ({
                                x: f.net_expense,
                                y: f['3_year'],
                                label: f.name,
                                isCurrent: f.name === fund.name
                            })),
                            backgroundColor: function(context) {
                                if (!context.raw) return 'rgba(52, 152, 219, 0.6)';
                                return context.raw.isCurrent ? 'rgba(231, 76, 60, 0.8)' : 'rgba(52, 152, 219, 0.6)';
                            },
                            borderColor: function(context) {
                                if (!context.raw) return 'rgba(52, 152, 219, 1)';
                                return context.raw.isCurrent ? 'rgba(231, 76, 60, 1)' : 'rgba(52, 152, 219, 1)';
                            },
                            borderWidth: 2,
                            pointRadius: function(context) {
                                if (!context.raw) return 6;
                                return context.raw.isCurrent ? 10 : 6;
                            },
                            pointHoverRadius: function(context) {
                                if (!context.raw) return 8;
                                return context.raw.isCurrent ? 12 : 8;
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].raw.label;
                                    },
                                    label: function(context) {
                                        return [
                                            'Expense Ratio: ' + context.parsed.x.toFixed(2) + '%',
                                            '3-Year Return: ' + context.parsed.y.toFixed(2) + '%'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { 
                                    display: true, 
                                    text: 'Expense Ratio (%)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: { font: { size: 12 } }
                            },
                            y: {
                                title: { 
                                    display: true, 
                                    text: '3-Year Annualized Return (%)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: { font: { size: 12 } }
                            }
                        }
                    }
                });
            } else {
                // If no 3-year data available, show a message
                riskReturnCtx.canvas.style.display = 'none';
                const parent = riskReturnCtx.canvas.parentElement;
                parent.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No 3-year performance data available for funds in this category.</p>';
            }
            
            // Category Comparison Chart - Multi-Period Line Chart
            if (categoryComparisonChart) categoryComparisonChart.destroy();
            const categoryCompCanvas = document.getElementById('categoryComparisonChart');
            const existingCategoryCompChart = Chart.getChart(categoryCompCanvas);
            if (existingCategoryCompChart) existingCategoryCompChart.destroy();
            const categoryCompCtx = categoryCompCanvas.getContext('2d');
            
            // Time periods in order
            const timePeriods = ['1_month', '3_month', 'ytd', '1_year', '3_year', '5_year'];
            const periodLabels = ['1 Month', '3 Month', 'YTD', '1 Year', '3 Year', '5 Year'];
            
            // Get all funds in the same category
            const categoryFundsForComparison = funds.filter(f => f.category === fund.category);
            
            // Create color palette for funds
            const colors = [
                'rgba(231, 76, 60, 1)',   // Red
                'rgba(52, 152, 219, 1)',   // Blue
                'rgba(46, 204, 113, 1)',   // Green
                'rgba(155, 89, 182, 1)',   // Purple
                'rgba(241, 196, 15, 1)',   // Yellow
                'rgba(230, 126, 34, 1)',   // Orange
                'rgba(26, 188, 156, 1)',   // Turquoise
                'rgba(52, 73, 94, 1)',     // Dark Gray
                'rgba(22, 160, 133, 1)',   // Sea Green
                'rgba(243, 156, 18, 1)',   // Gold
            ];
            
            // Create datasets for each fund
            const datasets = categoryFundsForComparison.map((f, idx) => {
                const data = timePeriods.map(p => f[p]);
                const isCurrentFund = f.name === fund.name;
                
                return {
                    label: f.name.length > 30 ? f.name.substring(0, 27) + '...' : f.name,
                    data: data,
                    borderColor: isCurrentFund ? 'rgba(231, 76, 60, 1)' : colors[idx % colors.length],
                    backgroundColor: isCurrentFund ? 'rgba(231, 76, 60, 0.1)' : colors[idx % colors.length].replace('1)', '0.1)'),
                    borderWidth: isCurrentFund ? 4 : 2,
                    pointRadius: isCurrentFund ? 6 : 4,
                    pointHoverRadius: isCurrentFund ? 8 : 6,
                    tension: 0.3,
                    fill: false
                };
            });
            
            // Move current fund to the end so it draws on top
            const currentFundIndex = datasets.findIndex(d => d.borderWidth === 4);
            if (currentFundIndex !== -1) {
                const currentFundDataset = datasets.splice(currentFundIndex, 1)[0];
                datasets.push(currentFundDataset);
            }
            
            categoryComparisonChart = new Chart(categoryCompCtx, {
                type: 'line',
                data: {
                    labels: periodLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                font: { size: 10 },
                                padding: 8,
                                boxWidth: 20,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    // Highlight current fund in legend
                                    original.forEach((label, idx) => {
                                        if (chart.data.datasets[idx].borderWidth === 4) {
                                            label.fontColor = 'rgba(231, 76, 60, 1)';
                                            label.fontStyle = 'bold';
                                        }
                                    });
                                    return original;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null || value === undefined) return context.dataset.label + ': N/A';
                                    return context.dataset.label + ': ' + value.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Return (%)',
                                font: { size: 13, weight: 'bold' }
                            },
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });
        });
    
// ===== TAB SWITCHING =====
function switchMainTab(tabName) {
    document.querySelectorAll('.month-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
    
    // Activate the correct tab button
    document.querySelectorAll('.month-tab').forEach(tab => {
        if (tab.getAttribute('onclick').includes("'" + tabName + "'")) {
            tab.classList.add('active');
        }
    });
    
    document.getElementById(tabName + '-pane').classList.add('active');
}

function switchStatsTab(tabName) {
    // Remove active class from all stats sub-tabs
    document.querySelectorAll('.stats-sub-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.stats-tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to clicked tab
    event.target.classList.add('active');
    
    // Show corresponding content
    document.getElementById('stats-' + tabName).classList.add('active');
}

function toggleStatsSection() {
    const container = document.getElementById('allStatsContainer');
    const button = document.getElementById('statsToggleBtn');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.textContent = 'Hide';
    } else {
        container.style.display = 'none';
        button.textContent = 'Show';
    }
}

function showAddMonthForm() {
    document.getElementById('addMonthForm').style.display = 'block';
}

function hideAddMonthForm() {
    document.getElementById('addMonthForm').style.display = 'none';
    document.getElementById('newMonthName').value = '';
}

function createMonth() {
    const name = document.getElementById('newMonthName').value.trim();
    if (!name) {
        alert('Please enter a portfolio name!');
        return;
    }
    
    const monthId = 'month_' + Date.now();
    monthsData[monthId] = { name: name, funds: [] };
    currentMonthId = monthId;
    saveMonthsData();
    renderMonthButtons();
    hideAddMonthForm();
    
    const currentNameEl = document.getElementById('currentMonthName');
    if (currentNameEl) {
        currentNameEl.textContent = name;
    }
    
    alert('‚úÖ Portfolio created! Now go to "Import Data" tab to upload your Excel file.');
}

function renderMonthButtons() {
    const selector = document.getElementById('monthSelector');
    if (!selector) {
        console.error('monthSelector element not found!');
        return;
    }
    
    console.log('Rendering buttons for portfolios:', Object.keys(monthsData).length);
    selector.innerHTML = '<button class="month-button" onclick="showAddMonthForm()">+ Add New Portfolio</button>';
    
    Object.keys(monthsData).forEach(monthId => {
        const btnDiv = document.createElement('div');
        btnDiv.className = 'month-button' + (monthId === currentMonthId ? ' active' : '');
        btnDiv.style.cssText = 'position: relative; display: inline-flex; align-items: center; cursor: pointer;';
        btnDiv.onclick = () => loadMonthData(monthId);
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = monthsData[monthId].name;
        nameSpan.style.flex = '1';
        
        const deleteBtn = document.createElement('span');
        deleteBtn.innerHTML = '√ó';
        deleteBtn.className = 'delete-portfolio-btn';
        deleteBtn.style.cssText = 'margin-left: 10px; font-size: 1.5em; font-weight: bold; color: #dc2626; cursor: pointer; padding: 0 5px;';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePortfolio(monthId);
        };
        
        btnDiv.appendChild(nameSpan);
        btnDiv.appendChild(deleteBtn);
        selector.appendChild(btnDiv);
        console.log('Added button for:', monthsData[monthId].name);
    });
}

function deletePortfolio(monthId) {
    const portfolioName = monthsData[monthId].name;
    
    if (confirm(`Are you sure you want to delete "${portfolioName}"?\n\nThis will permanently remove all data for this portfolio.`)) {
        delete monthsData[monthId];
        
        // If we're deleting the current portfolio, clear it
        if (currentMonthId === monthId) {
            currentMonthId = null;
        }
        
        saveMonthsData();
        renderMonthButtons();
        
        alert(`‚úÖ Portfolio "${portfolioName}" has been deleted.`);
    }
}

function loadMonthData(monthId) {
    console.log('Loading month:', monthId, monthsData[monthId]);
    
    currentMonthId = monthId;
    saveMonthsData();
    
    // Auto-switch to dashboard tab
    switchMainTab('dashboard');
    
    // Load the funds data into the dashboard
    if (monthsData[monthId] && monthsData[monthId].funds && monthsData[monthId].funds.length > 0) {
        console.log('Loading portfolio:', monthsData[monthId].name);
        console.log('Raw funds data:', monthsData[monthId].funds);
        console.log('Is array?', Array.isArray(monthsData[monthId].funds));
        
        // Replace the global funds array with this month's data (make a copy)
        try {
            window.funds = JSON.parse(JSON.stringify(monthsData[monthId].funds));
            
            // Verify it's a proper array
            if (!Array.isArray(window.funds)) {
                console.error('window.funds is not an array after assignment!');
                window.funds = [];
                alert('Error: Portfolio data is corrupted. Please re-import this portfolio.');
                return;
            }
            
            console.log('===== LOADING PORTFOLIO =====');
            console.log('Portfolio name:', monthsData[monthId].name);
            console.log('Loaded funds count:', window.funds.length);
            if (window.funds.length > 0) {
                console.log('First fund:', window.funds[0].name, '- YTD:', window.funds[0].ytd + '%');
                console.log('Sample tickers:', window.funds.slice(0, 5).map(f => f.ticker).join(', '));
            }
            console.log('============================');
        } catch (error) {
            console.error('Error parsing portfolio data:', error);
            alert('Error loading portfolio: ' + error.message + '\n\nPlease re-import this portfolio.');
            window.funds = [];
            return;
        }
        
        // Update the dashboard date display
        const dateDisplay = document.querySelector('.update-date');
        if (dateDisplay) {
            dateDisplay.textContent = 'üìÖ Dashboard Data: ' + monthsData[monthId].name;
        }
        
        // Re-render everything
        try {
            console.log('Calling updateStats()...');
            
            // CRITICAL FIX: Destroy all existing Chart.js instances
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.destroy();
            });
            
            // Clear the statsGrid HTML before regenerating
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.innerHTML = '';
            }
            
            // Call updateStats
            updateStats();
            console.log('updateStats() completed');
            
            // Reset filtered funds list for table sorting
            currentFilteredFunds = [...window.funds];
            
            // Re-render the fund listing table with new data
            if (typeof renderTable === 'function') {
                renderTable(window.funds);
            }
            
            // Re-setup filter button handlers with new funds
            if (typeof setupFilterHandlers === 'function') {
                setupFilterHandlers();
            }
            
            // Repopulate fund selector dropdown with new funds
            if (typeof populateFundSelector === 'function') {
                populateFundSelector();
            }
            
            // FORCE REGENERATE: Trigger resize to force chart redraws
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                console.log('Charts refreshed');
            }, 100);
            
        } catch (error) {
            console.error('Error rendering:', error);
            alert('Error updating dashboard: ' + error.message);
        }
        
        // Switch to dashboard tab (after updateStats completes)
        setTimeout(() => switchMainTab('dashboard'), 150);
        
        // Show success message
        alert('‚úÖ Loaded ' + monthsData[monthId].name + ' with ' + funds.length + ' funds!');
    } else {
        // Empty portfolio - keep default funds or set to empty array
        console.log('Portfolio has no data yet');
        alert('This portfolio has no data yet. Import data in the "Import Data" tab first!');
        
        // Don't leave window.funds in a broken state
        if (!window.funds || !Array.isArray(window.funds)) {
            window.funds = [];
        }
    }
    
    renderMonthButtons();
    const currentNameEl = document.getElementById('currentMonthName');
    if (currentNameEl) {
        currentNameEl.textContent = monthsData[monthId].name;
    }
    
    // Update download portfolio name
    const downloadNameEl = document.getElementById('downloadPortfolioName');
    if (downloadNameEl) {
        downloadNameEl.textContent = monthsData[monthId].name;
    }
}

// ===== EXCEL CONVERTER =====
let convertedWorkbook = null;
let originalFileName = "";

const tickerMap = {
    "Allspring Core Plus Bond Inst": "WIPIX",
    "Vanguard Equity-Income Adm": "VEIRX",
    "Vanguard Total Stock Mkt Idx Adm": "VTSAX",
    "Federated Hermes MDT Large Cap Growth IS": "QILGX",
    "American Century Mid Cap Value R6": "AMDVX",
    "T. Rowe Price Diversified Mid Cap Gr I": "RPTTX",
    "DFA US Targeted Value I": "DFFVX",
    "AB Small Cap Growth I": "QUAIX",
    "American Funds EUPAC R6": "RERGX",
    "Cullen Emerging Markets High Div I": "CEMFX",
    "Vanguard Target Retirement Income Inv": "VTINX",
    "Vanguard Target Retirement 2020 Inv": "VTWNX",
    "Vanguard Target Retirement 2025 Inv": "VTTVX",
    "Vanguard Target Retirement 2030 Inv": "VTHRX",
    "Vanguard Target Retirement 2035 Inv": "VTTHX",
    "Vanguard Target Retirement 2040 Inv": "VFORX",
    "Vanguard Target Retirement 2045 Inv": "VTIVX",
    "Vanguard Target Retirement 2050 Inv": "VFIFX",
    "Vanguard Target Retirement 2055 Inv": "VFFVX",
    "Vanguard Target Retirement 2060 Inv": "VTTSX",
    "Vanguard Target Retirement 2065 Inv": "VLXVX",
    "Vanguard Target Retirement 2070 Inv": "VSVNX",
    "Putnam Stable Value": "",
};

function getCategoryFromName(fundNameFull) {
    // The full name might include category on first line, fund name on second line
    // Example: "Large-Cap Stocks\nFederated Hermes MDT Large Cap Growth IS"
    
    // Split by newline and get the first line (the category)
    const lines = fundNameFull.split('\n');
    if (lines.length > 1) {
        // First line is the category
        const categoryLine = lines[0].trim();
        
        // Map the category line to our standard categories
        if (categoryLine.includes("Short Bonds") || categoryLine.includes("Stable") || categoryLine.includes("MMkt")) return "Short Bonds/Stable/MMkt";
        if (categoryLine.includes("Interm") || categoryLine.includes("Long-Term Bonds")) return "Interm./Long-Term Bonds";
        if (categoryLine.includes("Large-Cap")) return "Large-Cap Stocks";
        if (categoryLine.includes("Small") || categoryLine.includes("Mid")) return "Small/Mid-Cap Stocks";
        if (categoryLine.includes("International")) return "International Stocks";
        if (categoryLine.includes("Multi-Asset") || categoryLine.includes("Target")) return "Multi-Asset/Other";
        
        // Return the category line as-is if we don't have a specific mapping
        return categoryLine;
    }
    
    // Fallback: if no newline, detect from the fund name itself using specific fund patterns
    const fundName = fundNameFull.trim();
    
    // Specific fund name patterns for Large-Cap Stocks
    if (fundName.includes("Vanguard Equity-Income") || 
        fundName.includes("Vanguard Total Stock") || 
        fundName.includes("VTSAX") ||
        fundName.includes("VEIRX") ||
        fundName.includes("Federated Hermes MDT") ||
        fundName.includes("QILGX") ||
        fundName.includes("Large Cap Growth")) {
        return "Large-Cap Stocks";
    }
    
    // Specific patterns for Small/Mid-Cap Stocks
    if (fundName.includes("American Century Mid Cap") ||
        fundName.includes("T. Rowe Price") && fundName.includes("Mid Cap") ||
        fundName.includes("DFA US Targeted") ||
        fundName.includes("AB Small Cap") ||
        fundName.includes("AMDVX") ||
        fundName.includes("RPTTX") ||
        fundName.includes("DFFVX") ||
        fundName.includes("QUAIX")) {
        return "Small/Mid-Cap Stocks";
    }
    
    // Specific patterns for International Stocks
    if (fundName.includes("American Funds EUPAC") ||
        fundName.includes("Cullen Emerging") ||
        fundName.includes("RERGX") ||
        fundName.includes("CEMFX") ||
        fundName.includes("EUPAC") ||
        fundName.includes("Emerging Markets")) {
        return "International Stocks";
    }
    
    // Specific patterns for Bonds
    if (fundName.includes("Putnam Stable Value") ||
        fundName.includes("Stable Value")) {
        return "Short Bonds/Stable/MMkt";
    }
    
    if (fundName.includes("Allspring Core Plus Bond") ||
        fundName.includes("WIPIX") ||
        fundName.includes("Core Plus Bond")) {
        return "Interm./Long-Term Bonds";
    }
    
    // Target Retirement funds
    if (fundName.includes("Target Retirement") || fundName.includes("Vanguard Target")) {
        return "Multi-Asset/Other";
    }
    
    return "Multi-Asset/Other";
}

function getTickerFromName(fundName) {
    for (let key in tickerMap) {
        if (fundName.includes(key)) return tickerMap[key];
    }
    return "";
}

function handleConverterUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    originalFileName = file.name.replace('.xlsx', '').replace('.xls', '');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false});
            
            const newWorkbook = XLSX.utils.book_new();
            const outputData = [[
                "Fund Name", "Ticker Symbol", "Category", "Inception Date", "Unit Value",
                "YTD Return (%)", "1 Month Return (%)", "3 Month Return (%)",
                "1 Year Return (%)", "3 Year Return (%)", "5 Year Return (%)",
                "10 Year Return (%)", "Inception Return (%)",
                "Net Expense Ratio (%)"
            ]];
            
            let processedCount = 0;
            for (let i = 2; i < rows.length; i++) {
                const row = rows[i];
                if (row[0] && typeof row[0] === 'string' && row[0].length > 5) {
                    const fundNameFull = row[0];
                    const fundName = fundNameFull.includes('\n') ? fundNameFull.split('\n').pop().trim() : fundNameFull.trim();
                    const ticker = getTickerFromName(fundName);
                    const category = getCategoryFromName(fundNameFull);
                    
                    outputData.push([
                        fundName, ticker, category, row[1] || "", parseFloat(row[2]) || 0,
                        parseFloat(row[5]) || 0, parseFloat(row[3]) || 0, parseFloat(row[4]) || 0,
                        parseFloat(row[6]) || 0, parseFloat(row[7]) || 0, parseFloat(row[8]) || 0,
                        parseFloat(row[9]) || 0, parseFloat(row[10]) || 0,
                        parseFloat(row[12]) || 0
                    ]);
                    processedCount++;
                }
            }
            
            const newSheet = XLSX.utils.aoa_to_sheet(outputData);
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, "401k Fund Data");
            convertedWorkbook = newWorkbook;
            
            document.getElementById('converterStatus').textContent = `‚úÖ Successfully converted ${processedCount} funds!`;
            document.getElementById('converterResult').style.display = 'block';
        } catch (error) {
            alert('Error converting file: ' + error.message);
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function downloadConvertedFile() {
    if (!convertedWorkbook) {
        alert('No file to download');
        return;
    }
    const fileName = originalFileName + '_Dashboard_Ready.xlsx';
    XLSX.writeFile(convertedWorkbook, fileName);
    alert('File downloaded! Now go to "Import Data" tab.');
}

let pendingImportData = null;

function handleDataImport(event) {
    if (!currentMonthId) {
        alert('Please create a portfolio first in "My Portfolios" tab!');
        return;
    }
    
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Importing file for month:', currentMonthId, monthsData[currentMonthId].name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            const importedFunds = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row[0]) {
                    importedFunds.push({
                        name: row[0],
                        ticker: row[1] || "",
                        category: row[2] || "Multi-Asset/Other",
                        inception_date: row[3] || "",
                        unit_value: parseFloat(row[4]) || 0,
                        ytd: parseFloat(row[5]) || 0,
                        "1_month": parseFloat(row[6]) || 0,
                        "3_month": parseFloat(row[7]) || 0,
                        "1_year": parseFloat(row[8]) || 0,
                        "3_year": parseFloat(row[9]) || 0,
                        "5_year": parseFloat(row[10]) || 0,
                        "10_year": parseFloat(row[11]) || 0,
                        inception: parseFloat(row[12]) || 0,
                        net_expense: parseFloat(row[13]) || 0,
                        gross_expense: parseFloat(row[13]) || 0
                    });
                }
            }
            
            console.log('Parsed', importedFunds.length, 'funds');
            
            // Store pending data
            pendingImportData = importedFunds;
            
            // Show audit preview
            showAuditPreview(importedFunds);
            
        } catch (error) {
            console.error('Import error:', error);
            alert('Error importing file: ' + error.message);
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function showAuditPreview(funds) {
    const auditPreview = document.getElementById('auditPreview');
    const auditTableBody = document.getElementById('auditTableBody');
    
    // Store funds globally for sorting
    window.currentAuditFunds = funds;
    window.currentAuditSort = { column: null, direction: 'asc' };
    
    renderAuditTable(funds);
    
    auditPreview.style.display = 'block';
    auditPreview.scrollIntoView({ behavior: 'smooth' });
}

function renderAuditTable(funds) {
    const auditTableBody = document.getElementById('auditTableBody');
    
    auditTableBody.innerHTML = funds.map((f, idx) => `
        <tr style="border-bottom: 1px solid #e0e0e0; ${idx % 2 === 0 ? 'background: #f8f9fa;' : ''}">
            <td style="padding: 10px;">${idx + 1}</td>
            <td style="padding: 10px;">${f.name}</td>
            <td style="padding: 10px; font-weight: 600; color: #2563eb;">${f.ticker || 'N/A'}</td>
            <td style="padding: 10px; text-align: right; font-weight: 600;">${f.ytd.toFixed(2)}%</td>
            <td style="padding: 10px; text-align: right;">${f["1_month"].toFixed(2)}%</td>
            <td style="padding: 10px; text-align: right;">${f["1_year"].toFixed(2)}%</td>
            <td style="padding: 10px;">${f.category}</td>
        </tr>
    `).join('');
}

function sortAuditTable(column) {
    if (!window.currentAuditFunds) return;
    
    const funds = window.currentAuditFunds;
    const sortState = window.currentAuditSort;
    
    if (sortState.column === column) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.column = column;
        sortState.direction = 'asc';
    }
    
    const sortedFunds = [...funds].sort((a, b) => {
        let aVal, bVal;
        
        if (column === 'name' || column === 'ticker' || column === 'category') {
            aVal = (a[column] || '').toString().toLowerCase();
            bVal = (b[column] || '').toString().toLowerCase();
        } else {
            aVal = parseFloat(a[column]) || 0;
            bVal = parseFloat(b[column]) || 0;
        }
        
        if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    document.querySelectorAll('[id^="sort-"]').forEach(span => {
        span.textContent = '‚áÖ';
    });
    const indicator = document.getElementById(`sort-${column}`);
    if (indicator) {
        indicator.textContent = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº';
    }
    
    renderAuditTable(sortedFunds);
}

function confirmImport() {
    if (!pendingImportData) {
        alert('No data to import!');
        return;
    }
    
    monthsData[currentMonthId].funds = pendingImportData;
    saveMonthsData();
    
    console.log('=== IMPORT CONFIRMED ===');
    console.log('Saved', pendingImportData.length, 'funds to', monthsData[currentMonthId].name);
    
    alert(`‚úÖ Successfully imported ${pendingImportData.length} funds for ${monthsData[currentMonthId].name}!\n\nGo to "My Portfolios" and click the portfolio button to view!`);
    
    document.getElementById('auditPreview').style.display = 'none';
    pendingImportData = null;
    
    switchMainTab('history');
}

function cancelImport() {
    pendingImportData = null;
    document.getElementById('auditPreview').style.display = 'none';
    alert('Import cancelled. No data was saved.');
}

// Download current portfolio data as CSV
function downloadCurrentPortfolio() {
    if (!currentMonthId) {
        alert('‚ö†Ô∏è No portfolio selected! Please select a portfolio from "My Portfolios" tab first.');
        return;
    }
    
    const portfolio = monthsData[currentMonthId];
    if (!portfolio || !portfolio.funds || portfolio.funds.length === 0) {
        alert('‚ö†Ô∏è This portfolio has no data to download. Import data first!');
        return;
    }
    
    // Create CSV content - MUST MATCH Excel Converter format!
    const headers = ['Fund Name', 'Ticker Symbol', 'Category', 'Inception Date', 'Unit Value', 'YTD Return (%)', '1 Month Return (%)', '3 Month Return (%)', '1 Year Return (%)', '3 Year Return (%)', '5 Year Return (%)', '10 Year Return (%)', 'Inception Return (%)', 'Net Expense Ratio (%)'];
    
    const rows = portfolio.funds.map(fund => [
        fund.name || '',
        fund.ticker || '',
        fund.category || '',
        fund.inception_date || '',
        fund.unit_value || '',
        fund.ytd || '',
        fund['1_month'] || '',
        fund['3_month'] || '',
        fund['1_year'] || '',
        fund['3_year'] || '',
        fund['5_year'] || '',
        fund['10_year'] || '',
        fund.inception || '',
        fund.net_expense || ''
    ]);
    
    // Combine headers and rows
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
            // Escape commas and quotes in cell values
            const cellStr = String(cell);
            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                return '"' + cellStr.replace(/"/g, '""') + '"';
            }
            return cellStr;
        }).join(','))
    ].join('\n');
    
    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    // Use portfolio name for filename
    const filename = `${portfolio.name.replace(/[^a-z0-9]/gi, '_')}_data.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`‚úÖ Downloaded "${portfolio.name}" portfolio data as ${filename}`);
}

// Initialize
renderMonthButtons();
updateStats();  // Initial render of stats with default data
regeneratePortfolioOptimizer();  // Initial Portfolio Optimizer
regenerateAdvancedAnalytics();  // Initial Advanced Analytics


</script>
        </div> <!-- Close dashboard-pane -->
</body>
</html>
